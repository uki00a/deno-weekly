<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>fresh v1.5 | 週刊Deno</title><meta name=keywords content="fresh,Preact"><meta name=description content="fresh v1.5がリリース。SPAライクなクライアントサイドナビゲーションを実現するために、Partialsという機能が導入されました。"><meta name=author content><link rel=canonical href=https://uki00a.github.io/deno-weekly/articles/fresh/v1.5.html><link crossorigin=anonymous href=/deno-weekly/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/deno-weekly/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://raw.githubusercontent.com/uki00a/blog/master/src/assets/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://uki00a.github.io/deno-weekly/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://uki00a.github.io/deno-weekly/favicon-32x32.png><link rel=apple-touch-icon href=https://uki00a.github.io/deno-weekly/apple-touch-icon.png><link rel=mask-icon href=https://uki00a.github.io/deno-weekly/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:image" content="https://raw.githubusercontent.com/uki00a/blog/master/src/assets/avatar.png"><meta property="twitter:image" content="https://raw.githubusercontent.com/uki00a/blog/master/src/assets/avatar.png"><meta name=twitter:site content="@uki00a"><script async src="https://www.googletagmanager.com/gtag/js?id=G-MK2K2MRMBF"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-MK2K2MRMBF",{anonymize_ip:!1})}</script><meta property="og:title" content="fresh v1.5"><meta property="og:description" content="fresh v1.5がリリース。SPAライクなクライアントサイドナビゲーションを実現するために、Partialsという機能が導入されました。"><meta property="og:type" content="article"><meta property="og:url" content="https://uki00a.github.io/deno-weekly/articles/fresh/v1.5.html"><meta property="article:section" content="articles"><meta property="article:published_time" content="2023-10-15T00:00:00+00:00"><meta property="article:modified_time" content="2023-10-15T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="fresh v1.5"><meta name=twitter:description content="fresh v1.5がリリース。SPAライクなクライアントサイドナビゲーションを実現するために、Partialsという機能が導入されました。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"fresh v1.5","item":"https://uki00a.github.io/deno-weekly/articles/fresh/v1.5.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"fresh v1.5","name":"fresh v1.5","description":"fresh v1.5がリリース。SPAライクなクライアントサイドナビゲーションを実現するために、Partialsという機能が導入されました。","keywords":["fresh","Preact"],"articleBody":"fresh v1.5がリリースされました。\nこの記事では主な変更点などについて解説します。\nPartials SPAライクなクライアントサイドでのページ遷移を実現するためにPartialsという機能が導入されました。\n基本的な使い方 以下のコードを例に見てみます。\n// routes/docs/[id].tsx import { Partial } from \"$fresh/runtime.ts\";  export default function Page({ docs, currentDoc }: { docs: ArrayDoc, currentDoc: Doc }) {  return (    Sidebar docs={docs} /  Partial name=\"docs-main-content\"  MainContent doc={currentDoc} /  Partial    ); }  function Sidebar({ docs }: { docs: ArrayDoc }) {  return (  nav f-client-nav  ul class=\"flex flex-col gap-2\"  {docs.map((doc) = (  li key={doc.id} class=\"shadow-md p-4\"  a href={`/docs/${doc.id}`} class=\"font-bold\"{doc.title}a  li  ))}  ul  nav  ); } Partialsを有効化する上で重要なのは以下の点です。\n クライアントサイドナビゲーションを有効化したいリンクを子孫に持つコンテナ要素に**f-client-nav**属性を指定する。  nav f-client-nav  // ...  a href={`/docs/${doc.id}`} class=\"font-bold\"{doc.title}a  // ...  nav  クライアントサイドナビゲーションの実行時に動的に変化して欲しい領域をでラップする  // ...  Partial name=\"docs-main-content\"  MainContent doc={currentDoc} /  Partial   こうすることで、f-client-navが指定されたコンテナ要素配下にあるリンクをクリックした際に、ページ全体のリロードが行われずにクライアントサイド側でのページ遷移が行われます。この際に、で囲まれた領域のみが更新されます。\nデフォルトでは、freshはf-client-navが指定されたコンテナの子孫のリンクがクリックされた際に、hrefで指定されたURLに対してfetch()でリクエストを行います。すると、freshのサーバーが対象ページをSSRした結果をHTMLとして返却するため、その中からで囲まれた領域に該当するHTMLのみを抽出して内容を差し替えます。このようにすることで、ページ全体でのリロードの発生を回避しています。\nf-partialによる最適化について f-client-navによるクライアントサイドでのページ遷移の実行時に、freshはfetch()によってページ全体のSSRを要求します。そのため、場合によっては、多少のオーバーヘッドが生じる可能性も考えられます。\nそういったケースでは、f-partial属性を活用することで最適化が可能です。\nfunction Sidebar({ docs }: { docs: ArrayDoc }) {  return (  nav f-client-nav  ul class=\"flex flex-col gap-2\"  {docs.map((doc) = (  li key={doc.id} class=\"shadow-md p-4\"  a  href={`/docs/${doc.id}`}  f-partial={`/partials/docs/${doc.id}`}  class=\"font-bold\"    {doc.title}  a  li  ))}  ul  nav  ); } 例えば、上記のコードでは、要素にhref属性とは別にf-partial属性が設定されています。freshはこのようなリンクがクリックされた際は、hrefではなくf-partialで指定されたURLに対してfetch()を実行します。(freshがfetch()で問い合わせる先のURLが変わるだけで、ページ遷移後のブラウザーのURLについてはhrefで指定された方のURLに更新されます。)\n上記のケースでは/partials/docs/${doc.id}に対して問い合わせが行われるため、routes/partials/docs/[id].tsxにを返却するルートを定義しておきます。\n// routes/partials/docs/[id].tsx import { Partial } from \"$fresh/runtime.ts\"; import { defineRoute } from \"$fresh/server.ts\";  export default defineRoute(async (_, ctx) = {  const doc = await loadDoc(ctx.params.id);  return (  Partial name=\"docs-main-content\"  MainContent doc={doc} /  Partial  ); }); こうすることでページ全体がSSRされることを回避できるため、パフォーマンスの改善が期待されます。\n置き換えモード コンポーネントには任意でprops.modeを指定できます。\nこれによって、ページ遷移後のの更新方法をカスタマイズできます。\n   props.mode ページ遷移時の挙動     replace 配下の内容を新しい内容でそのまま置き換える (デフォルト)   prepend の先頭に新しい内容を挿入する   append の末尾に新しい内容を挿入する     data-current/data-ancestor属性の導入 要素に自動でdata-current/data-ancestor属性が付与されるようになりました。\n   属性 付与される条件     data-current 該当の要素のhrefが現在のページのURLに一致する場合に付与されます。   data-ancestor 該当の要素のhrefが現在のページのURLの子孫ページである場合に付与されます。 (例: 現在のページが/usersで該当要素のhref属性が/users/123であればdata-ancestorが設定されます)    スタイルの適用を容易にするために使用されることが想定されているようです。\n// Twindでの使用例 a  class=\"[data-current]:font-bold\"  href={x.link}   {x.title} a  事前ビルド プラグインに実験的なbuildStartとbuildEndフックの追加 プラグインにbuildStartとbuildEndという2種類のフックが追加されました。\n⚠️これらのフックはまだ実験的APIという位置づけのため、今後、変更が入る可能性があります。\nimport type { Plugin } from \"$fresh/server.ts\";  const samplePlugin: Plugin = {  name: \"sample\",  buildStart() {  console.info(\"[build] 事前ビルドを開始します...\");  },  buildEnd() {  console.info(\"[build] 事前ビルドが完了しました。\")  } }; それぞれdeno task buildによる事前ビルドの実行前後のタイミングで呼ばれます。\nこれらによって、将来的にプラグイン経由でTailwind CSSやSassなどを利用できるようにすることなどが想定されているようです。\nesbuildのメタファイルがサポート esbuildのメタファイルがサポートされました。\ndeno task buildを実行すると、_fresh/metafile.jsonにメタファイルが保存されます。\nBundle Size Analyzerなどで分析できます。\n freshの設定 (fresh.config.ts) 事前ビルドの出力先ディレクトリのカスタマイズ (build.outDir) FreshOptionsにbuild.outDirオプションが追加されました。\nこれを指定することで、deno task buildの実行結果を_fresh以外のディレクトリへ出力できます。\n例えば、以下の場合、./distにビルド結果が出力されます。\n// fresh.config.ts import { defineConfig } from \"$fresh/server.ts\"; import twindPlugin from \"$fresh/plugins/twind.ts\"; import twindConfig from \"./twind.config.ts\";  export default defineConfig({  plugins: [twindPlugin(twindConfig)],  build: {  outDir: \"./dist\",  }, }); esbuildのターゲットのカスタマイズ (build.target) FreshOptionsにbuild.targetオプションが追加されています。\nこれによりesbuildのtargetオプションをカスタマイズできます\n// fresh.config.ts export default defineConfig({  plugins: [twindPlugin(twindConfig)],  build: {  target: [\"es2020\"],  }, }); 無視したいルートファイルのパターンの指定がサポート (router.ignoreFilePattern) router.ignoreFilePatternオプションが追加されました。routes/配下において無視したいファイルのパターンを指定できます。\nデフォルトでは、routes配下のテストファイル(*.test.tsなど)が無視されるよう設定されています。\n// fresh.config.ts export default defineConfig({  plugins: [twindPlugin(twindConfig)],  router: {  // 例) `*.spec.ts(x)`ファイルを無視する  ignoreFilePattern: /\\.spec\\.(?:ts|tsx)$/  } }); サーバーに関する設定のカスタマイズがサポート (FreshOptions.server) serverオプションによってfreshの起動ポートなどをカスタマイズできます。\n// fresh.config.ts export default defineConfig({  plugins: [twindPlugin(twindConfig)],  server: {  port: 3000,  }, });  サーバー オプショナルなダイナミックルートパラメータ [[name]]のような形式でオプショナルなダイナミックルートパラメータを定義できるようになりました。\n例えば、routes/docs/[[version]]/index.tsxを用意しておくと、以下のいずれかのパターンにマッチします。\n /docs/v1 /docs/  非Islandコンポーネントでのフックの使用について 非IslandコンポーネントでuseStateまたはuseReducerを使用した際に、以下のようなエラーが発生するように改善されました。\nError: Hook \"useState\" cannot be used outside of an island component.  その他の改善点 デフォルトのエラーページの改善 開発時にエラーが発生した際のデフォルトのエラーページが改善されました。\n以下のようにエラーが発生した箇所とその周辺のソースコードが表示されます。\nエラーメッセージ 5 | export default function Home() { 6 | const count = useSignal(3);  7 | throw new Error(\"エラーメッセージ\"); | ^ 8 | return ( 9 |  10 |  インラインのへのnonceの付与 以下のようなインラインのにもnonceが付与されるように改善されました。\nscript dangerouslySetInnerHTML={{ __html: \"alert('hi')\" }} / 配下の要素でのkeyのサポートについて 以下のように同一ページで複数回が使用された際に、重複したタグが出力される問題を修正することが目的のようです\n例えば、以下のようにnameが重複したが複数回宣言されていたとします。\nHead  meta name=\"og:title\" content=\"foo\" / Head Head  meta name=\"og:title\" content=\"bar\" / Head この場合、freshはタグ配下に以下のようなタグを生成します。\nこういった場合、にkey属性を指定することで重複を取り除くことができます。\nHead  meta name=\"og:title\" content=\"foo\" key=\"title\" / Head Head  meta name=\"og:title\" content=\"bar\" key=\"title\" / Head この場合、タグ配下には以下のようにタグが生成されます。\nmeta name=\"og:title\" content=\"bar\" / 参考  https://github.com/denoland/fresh/releases/tag/1.5.0 Fresh 1.5: Partials, client side navigation and more  ","wordCount":"458","inLanguage":"en","datePublished":"2023-10-15T00:00:00Z","dateModified":"2023-10-15T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://uki00a.github.io/deno-weekly/articles/fresh/v1.5.html"},"publisher":{"@type":"Organization","name":"週刊Deno","logo":{"@type":"ImageObject","url":"https://raw.githubusercontent.com/uki00a/blog/master/src/assets/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://uki00a.github.io/deno-weekly/ accesskey=h title="週刊Deno (Alt + H)">週刊Deno</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://uki00a.github.io/deno-weekly/tags.html title=タグ><span><i class="fa fa-heart"></i>タグ</span></a></li><li><a href=https://uki00a.github.io/deno-weekly/categories.html title=カテゴリー><span><i class="fa fa-heart"></i>カテゴリー</span></a></li><li><a href=https://uki00a.github.io/deno-weekly/gallery.html title=ギャラリー><span><i class="fa fa-road"></i>ギャラリー<span class=alert></span></span></a></li><li><a href=https://uki00a.github.io/deno-weekly/index.xml title="RSS feed"><span><i class="fa fa-road"></i>RSS feed<span class=alert></span></span></a></li><li><a href=https://uki00a.github.io/deno-weekly/about.html title=About><span><i class="fa fa-road"></i>About<span class=alert></span></span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>fresh v1.5</h1><div class=post-description>fresh v1.5がリリース。SPAライクなクライアントサイドナビゲーションを実現するために、Partialsという機能が導入されました。</div><div class=post-meta><span title="2023-10-15 00:00:00 +0000 UTC">October 15, 2023</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#partials aria-label=Partials>Partials</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e7%9a%84%e3%81%aa%e4%bd%bf%e3%81%84%e6%96%b9 aria-label=基本的な使い方>基本的な使い方</a></li><li><a href=#f-partial%e3%81%ab%e3%82%88%e3%82%8b%e6%9c%80%e9%81%a9%e5%8c%96%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6 aria-label=f-partialによる最適化について><code>f-partial</code>による最適化について</a></li><li><a href=#%e7%bd%ae%e3%81%8d%e6%8f%9b%e3%81%88%e3%83%a2%e3%83%bc%e3%83%89 aria-label=置き換えモード>置き換えモード</a></li></ul></li><li><a href=#data-currentdata-ancestor%e5%b1%9e%e6%80%a7%e3%81%ae%e5%b0%8e%e5%85%a5 aria-label=data-current/data-ancestor属性の導入><code>data-current</code>/<code>data-ancestor</code>属性の導入</a></li><li><a href=#%e4%ba%8b%e5%89%8d%e3%83%93%e3%83%ab%e3%83%89 aria-label=事前ビルド>事前ビルド</a><ul><li><a href=#%e3%83%97%e3%83%a9%e3%82%b0%e3%82%a4%e3%83%b3%e3%81%ab%e5%ae%9f%e9%a8%93%e7%9a%84%e3%81%aabuildstart%e3%81%a8buildend%e3%83%95%e3%83%83%e3%82%af%e3%81%ae%e8%bf%bd%e5%8a%a0 aria-label=プラグインに実験的なbuildStartとbuildEndフックの追加>プラグインに実験的な<code>buildStart</code>と<code>buildEnd</code>フックの追加</a></li><li><a href=#esbuild%e3%81%ae%e3%83%a1%e3%82%bf%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=esbuildのメタファイルがサポート>esbuildのメタファイルがサポート</a></li></ul></li><li><a href=#fresh%e3%81%ae%e8%a8%ad%e5%ae%9a-freshconfigts aria-label="freshの設定 (fresh.config.ts)">freshの設定 (<code>fresh.config.ts</code>)</a><ul><li><a href=#%e4%ba%8b%e5%89%8d%e3%83%93%e3%83%ab%e3%83%89%e3%81%ae%e5%87%ba%e5%8a%9b%e5%85%88%e3%83%87%e3%82%a3%e3%83%ac%e3%82%af%e3%83%88%e3%83%aa%e3%81%ae%e3%82%ab%e3%82%b9%e3%82%bf%e3%83%9e%e3%82%a4%e3%82%ba-buildoutdir aria-label="事前ビルドの出力先ディレクトリのカスタマイズ (build.outDir)">事前ビルドの出力先ディレクトリのカスタマイズ (<code>build.outDir</code>)</a></li><li><a href=#esbuild%e3%81%ae%e3%82%bf%e3%83%bc%e3%82%b2%e3%83%83%e3%83%88%e3%81%ae%e3%82%ab%e3%82%b9%e3%82%bf%e3%83%9e%e3%82%a4%e3%82%ba-buildtarget aria-label="esbuildのターゲットのカスタマイズ (build.target)">esbuildのターゲットのカスタマイズ (<code>build.target</code>)</a></li><li><a href=#%e7%84%a1%e8%a6%96%e3%81%97%e3%81%9f%e3%81%84%e3%83%ab%e3%83%bc%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%ae%e3%83%91%e3%82%bf%e3%83%bc%e3%83%b3%e3%81%ae%e6%8c%87%e5%ae%9a%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88-routerignorefilepattern aria-label="無視したいルートファイルのパターンの指定がサポート (router.ignoreFilePattern)">無視したいルートファイルのパターンの指定がサポート (<code>router.ignoreFilePattern</code>)</a></li><li><a href=#%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc%e3%81%ab%e9%96%a2%e3%81%99%e3%82%8b%e8%a8%ad%e5%ae%9a%e3%81%ae%e3%82%ab%e3%82%b9%e3%82%bf%e3%83%9e%e3%82%a4%e3%82%ba%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88-freshoptionsserver aria-label="サーバーに関する設定のカスタマイズがサポート (FreshOptions.server)">サーバーに関する設定のカスタマイズがサポート (<code>FreshOptions.server</code>)</a></li></ul></li><li><a href=#%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc aria-label=サーバー>サーバー</a><ul><li><a href=#%e3%82%aa%e3%83%97%e3%82%b7%e3%83%a7%e3%83%8a%e3%83%ab%e3%81%aa%e3%83%80%e3%82%a4%e3%83%8a%e3%83%9f%e3%83%83%e3%82%af%e3%83%ab%e3%83%bc%e3%83%88%e3%83%91%e3%83%a9%e3%83%a1%e3%83%bc%e3%82%bf aria-label=オプショナルなダイナミックルートパラメータ>オプショナルなダイナミックルートパラメータ</a></li><li><a href=#%e9%9d%9eisland%e3%82%b3%e3%83%b3%e3%83%9d%e3%83%bc%e3%83%8d%e3%83%b3%e3%83%88%e3%81%a7%e3%81%ae%e3%83%95%e3%83%83%e3%82%af%e3%81%ae%e4%bd%bf%e7%94%a8%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6 aria-label=非Islandコンポーネントでのフックの使用について>非Islandコンポーネントでのフックの使用について</a></li></ul></li><li><a href=#%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e6%94%b9%e5%96%84%e7%82%b9 aria-label=その他の改善点>その他の改善点</a><ul><li><a href=#%e3%83%87%e3%83%95%e3%82%a9%e3%83%ab%e3%83%88%e3%81%ae%e3%82%a8%e3%83%a9%e3%83%bc%e3%83%9a%e3%83%bc%e3%82%b8%e3%81%ae%e6%94%b9%e5%96%84 aria-label=デフォルトのエラーページの改善>デフォルトのエラーページの改善</a></li><li><a href=#%e3%82%a4%e3%83%b3%e3%83%a9%e3%82%a4%e3%83%b3%e3%81%aescript%e3%81%b8%e3%81%aenonce%e3%81%ae%e4%bb%98%e4%b8%8e aria-label=インラインの&amp;lt;script&amp;gt;へのnonceの付与>インラインの<code>&lt;script></code>への<code>nonce</code>の付与</a></li><li><a href=#head%e9%85%8d%e4%b8%8b%e3%81%ae%e8%a6%81%e7%b4%a0%e3%81%a7%e3%81%aekey%e3%81%ae%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6 aria-label=&amp;lt;Head&amp;gt;配下の要素でのkeyのサポートについて><code>&lt;Head></code>配下の要素での<code>key</code>のサポートについて</a></li></ul></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div><div class=post-content><p>fresh v1.5がリリースされました。</p><p>この記事では主な変更点などについて解説します。</p><h2 id=partials>Partials<a hidden class=anchor aria-hidden=true href=#partials>#</a></h2><p>SPAライクなクライアントサイドでのページ遷移を実現するために<strong>Partials</strong>という機能が導入されました。</p><h3 id=基本的な使い方>基本的な使い方<a hidden class=anchor aria-hidden=true href=#基本的な使い方>#</a></h3><p>以下のコードを例に見てみます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span><span style=color:#75715e>// routes/docs/[id].tsx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Partial</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;$fresh/runtime.ts&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Page</span>({ <span style=color:#a6e22e>docs</span>, <span style=color:#a6e22e>currentDoc</span> }<span style=color:#f92672>:</span> { <span style=color:#a6e22e>docs</span>: <span style=color:#66d9ef>Array</span>&lt;<span style=color:#f92672>Doc</span>&gt;, <span style=color:#a6e22e>currentDoc</span>: <span style=color:#66d9ef>Doc</span> }) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>    &lt;&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>Sidebar</span> <span style=color:#a6e22e>docs</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>docs</span>} /&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>Partial</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;docs-main-content&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>MainContent</span> <span style=color:#a6e22e>doc</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>currentDoc</span>} /&gt;
</span></span><span style=display:flex><span>      &lt;/<span style=color:#f92672>Partial</span>&gt;
</span></span><span style=display:flex><span>    &lt;/&gt;
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Sidebar</span>({ <span style=color:#a6e22e>docs</span> }<span style=color:#f92672>:</span> { <span style=color:#a6e22e>docs</span>: <span style=color:#66d9ef>Array</span>&lt;<span style=color:#f92672>Doc</span>&gt; }) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>nav</span> <span style=color:#a6e22e>f</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>client</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>nav</span>&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>ul</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;flex flex-col gap-2&#34;</span>&gt;
</span></span><span style=display:flex><span>        {<span style=color:#a6e22e>docs</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>doc</span>) <span style=color:#f92672>=&gt;</span> (
</span></span><span style=display:flex><span>          &lt;<span style=color:#f92672>li</span> <span style=color:#a6e22e>key</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>id</span>} <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;shadow-md p-4&#34;</span>&gt;
</span></span><span style=display:flex><span>            &lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span>{<span style=color:#e6db74>`/docs/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>} <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;font-bold&#34;</span>&gt;{<span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>title</span>}&lt;/<span style=color:#f92672>a</span>&gt;
</span></span><span style=display:flex><span>          &lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>        ))}
</span></span><span style=display:flex><span>      &lt;/<span style=color:#f92672>ul</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>nav</span>&gt;
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Partialsを有効化する上で重要なのは以下の点です。</p><ol><li>クライアントサイドナビゲーションを有効化したいリンクを子孫に持つコンテナ要素に**<code>f-client-nav</code>**属性を指定する。<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span>  &lt;<span style=color:#f92672>nav</span> <span style=color:#a6e22e>f</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>client</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>nav</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          &lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span>{<span style=color:#e6db74>`/docs/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>} <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;font-bold&#34;</span>&gt;{<span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>title</span>}&lt;/<span style=color:#f92672>a</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  &lt;/<span style=color:#f92672>nav</span>&gt;
</span></span></code></pre></div></li><li>クライアントサイドナビゲーションの実行時に動的に変化して欲しい領域を<a href="https://deno.land/x/fresh@1.5.0/runtime.ts?doc=&s=Partial"><strong><code>&lt;Partial></code></strong></a>でラップする<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  &lt;<span style=color:#f92672>Partial</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;docs-main-content&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>MainContent</span> <span style=color:#a6e22e>doc</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>currentDoc</span>} /&gt;
</span></span><span style=display:flex><span>  &lt;/<span style=color:#f92672>Partial</span>&gt;
</span></span></code></pre></div></li></ol><p>こうすることで、<code>f-client-nav</code>が指定されたコンテナ要素配下にあるリンクをクリックした際に、ページ全体のリロードが行われずにクライアントサイド側でのページ遷移が行われます。この際に、<strong><code>&lt;Partial></code>で囲まれた領域のみが更新されます。</strong></p><p>デフォルトでは、freshは<code>f-client-nav</code>が指定されたコンテナの子孫のリンクがクリックされた際に、<code>href</code>で指定されたURLに対して<code>fetch()</code>でリクエストを行います。すると、freshのサーバーが対象ページをSSRした結果をHTMLとして返却するため、その中から<code>&lt;Partial></code>で囲まれた領域に該当するHTMLのみを抽出して内容を差し替えます。このようにすることで、ページ全体でのリロードの発生を回避しています。</p><h3 id=f-partialによる最適化について><code>f-partial</code>による最適化について<a hidden class=anchor aria-hidden=true href=#f-partialによる最適化について>#</a></h3><p><code>f-client-nav</code>によるクライアントサイドでのページ遷移の実行時に、freshは<code>fetch()</code>によってページ全体のSSRを要求します。そのため、場合によっては、多少のオーバーヘッドが生じる可能性も考えられます。</p><p>そういったケースでは、<code>f-partial</code>属性を活用することで最適化が可能です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Sidebar</span>({ <span style=color:#a6e22e>docs</span> }<span style=color:#f92672>:</span> { <span style=color:#a6e22e>docs</span>: <span style=color:#66d9ef>Array</span>&lt;<span style=color:#f92672>Doc</span>&gt; }) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>nav</span> <span style=color:#a6e22e>f</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>client</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>nav</span>&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>ul</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;flex flex-col gap-2&#34;</span>&gt;
</span></span><span style=display:flex><span>        {<span style=color:#a6e22e>docs</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>doc</span>) <span style=color:#f92672>=&gt;</span> (
</span></span><span style=display:flex><span>          &lt;<span style=color:#f92672>li</span> <span style=color:#a6e22e>key</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>id</span>} <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;shadow-md p-4&#34;</span>&gt;
</span></span><span style=display:flex><span>            &lt;<span style=color:#f92672>a</span>
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span>{<span style=color:#e6db74>`/docs/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>}
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>f</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>partial</span><span style=color:#f92672>=</span>{<span style=color:#e6db74>`/partials/docs/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>}
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;font-bold&#34;</span>
</span></span><span style=display:flex><span>            &gt;
</span></span><span style=display:flex><span>              {<span style=color:#a6e22e>doc</span>.<span style=color:#a6e22e>title</span>}
</span></span><span style=display:flex><span>            &lt;/<span style=color:#f92672>a</span>&gt;
</span></span><span style=display:flex><span>          &lt;/<span style=color:#f92672>li</span>&gt;
</span></span><span style=display:flex><span>        ))}
</span></span><span style=display:flex><span>      &lt;/<span style=color:#f92672>ul</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>nav</span>&gt;
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>例えば、上記のコードでは、<code>&lt;a></code>要素に<code>href</code>属性とは別に<code>f-partial</code>属性が設定されています。freshはこのようなリンクがクリックされた際は、<code>href</code>ではなく<code>f-partial</code>で指定されたURLに対して<code>fetch()</code>を実行します。(freshが<code>fetch()</code>で問い合わせる先のURLが変わるだけで、ページ遷移後のブラウザーのURLについては<code>href</code>で指定された方のURLに更新されます。)</p><p>上記のケースでは<code>/partials/docs/${doc.id}</code>に対して問い合わせが行われるため、<code>routes/partials/docs/[id].tsx</code>に<code>&lt;Partial></code>を返却するルートを定義しておきます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span><span style=color:#75715e>// routes/partials/docs/[id].tsx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Partial</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;$fresh/runtime.ts&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>defineRoute</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;$fresh/server.ts&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>defineRoute</span>(<span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ctx</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>doc</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>loadDoc</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>Partial</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;docs-main-content&#34;</span>&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>MainContent</span> <span style=color:#a6e22e>doc</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>doc</span>} /&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>Partial</span>&gt;
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>こうすることでページ全体がSSRされることを回避できるため、パフォーマンスの改善が期待されます。</p><h3 id=置き換えモード>置き換えモード<a hidden class=anchor aria-hidden=true href=#置き換えモード>#</a></h3><p><code>&lt;Partial></code>コンポーネントには任意で<a href="https://deno.land/x/fresh@1.5.0/runtime.ts?doc=&s=PartialProps#prop_mode">props.mode</a>を指定できます。</p><p>これによって、ページ遷移後の<code>&lt;Partial></code>の更新方法をカスタマイズできます。</p><table><thead><tr><th style=text-align:center><code>props.mode</code></th><th style=text-align:center>ページ遷移時の挙動</th></tr></thead><tbody><tr><td style=text-align:center><code>replace</code></td><td style=text-align:center><code>&lt;Partial></code>配下の内容を新しい内容でそのまま置き換える (デフォルト)</td></tr><tr><td style=text-align:center><code>prepend</code></td><td style=text-align:center><code>&lt;Partial></code>の先頭に新しい内容を挿入する</td></tr><tr><td style=text-align:center><code>append</code></td><td style=text-align:center><code>&lt;Partial></code>の末尾に新しい内容を挿入する</td></tr></tbody></table><hr><h2 id=data-currentdata-ancestor属性の導入><code>data-current</code>/<code>data-ancestor</code>属性の導入<a hidden class=anchor aria-hidden=true href=#data-currentdata-ancestor属性の導入>#</a></h2><p><code>&lt;a></code>要素に自動で<code>data-current</code>/<code>data-ancestor</code>属性が付与されるようになりました。</p><table><thead><tr><th style=text-align:center>属性</th><th style=text-align:center>付与される条件</th></tr></thead><tbody><tr><td style=text-align:center><code>data-current</code></td><td style=text-align:center>該当の<code>&lt;a></code>要素の<code>href</code>が現在のページのURLに一致する場合に付与されます。</td></tr><tr><td style=text-align:center><code>data-ancestor</code></td><td style=text-align:center>該当の<code>&lt;a></code>要素の<code>href</code>が現在のページのURLの子孫ページである場合に付与されます。 (例: 現在のページが<code>/users</code>で該当要素の<code>href</code>属性が<code>/users/123</code>であれば<code>data-ancestor</code>が設定されます)</td></tr></tbody></table><p>スタイルの適用を容易にするために使用されることが想定されているようです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span><span style=color:#75715e>// Twindでの使用例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>&lt;<span style=color:#f92672>a</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;[data-current]:font-bold&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>link</span>}
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>  {<span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>title</span>}
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>a</span>&gt;
</span></span></code></pre></div><hr><h2 id=事前ビルド>事前ビルド<a hidden class=anchor aria-hidden=true href=#事前ビルド>#</a></h2><h3 id=プラグインに実験的なbuildstartとbuildendフックの追加>プラグインに実験的な<code>buildStart</code>と<code>buildEnd</code>フックの追加<a hidden class=anchor aria-hidden=true href=#プラグインに実験的なbuildstartとbuildendフックの追加>#</a></h3><p>プラグインに<code>buildStart</code>と<code>buildEnd</code>という2種類のフックが追加されました。</p><p><strong>⚠️これらのフックはまだ実験的APIという位置づけのため、今後、変更が入る可能性があります。</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#66d9ef>type</span> { <span style=color:#a6e22e>Plugin</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;$fresh/server.ts&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>samplePlugin</span>: <span style=color:#66d9ef>Plugin</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;sample&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>buildStart() {</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;[build] 事前ビルドを開始します...&#34;</span>);
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>buildEnd() {</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;[build] 事前ビルドが完了しました。&#34;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>それぞれ<a href=https://uki00a.github.io/deno-weekly/articles/fresh/v1.4.html>deno task build</a>による事前ビルドの実行前後のタイミングで呼ばれます。</p><p>これらによって、将来的にプラグイン経由でTailwind CSSやSassなどを利用できるようにすることなどが想定されているようです。</p><h3 id=esbuildのメタファイルがサポート>esbuildのメタファイルがサポート<a hidden class=anchor aria-hidden=true href=#esbuildのメタファイルがサポート>#</a></h3><p>esbuildのメタファイルがサポートされました。</p><p><code>deno task build</code>を実行すると、<code>_fresh/metafile.json</code>にメタファイルが保存されます。</p><p><a href=https://esbuild.github.io/analyze/>Bundle Size Analyzer</a>などで分析できます。</p><hr><h2 id=freshの設定-freshconfigts>freshの設定 (<code>fresh.config.ts</code>)<a hidden class=anchor aria-hidden=true href=#freshの設定-freshconfigts>#</a></h2><h3 id=事前ビルドの出力先ディレクトリのカスタマイズ-buildoutdir>事前ビルドの出力先ディレクトリのカスタマイズ (<code>build.outDir</code>)<a hidden class=anchor aria-hidden=true href=#事前ビルドの出力先ディレクトリのカスタマイズ-buildoutdir>#</a></h3><p><a href="https://deno.land/x/fresh@1.5.0/server.ts?doc=&s=FreshOptions">FreshOptions</a>に<code>build.outDir</code>オプションが追加されました。</p><p>これを指定することで、<code>deno task build</code>の実行結果を<code>_fresh</code>以外のディレクトリへ出力できます。</p><p>例えば、以下の場合、<code>./dist</code>にビルド結果が出力されます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span><span style=color:#75715e>// fresh.config.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>defineConfig</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;$fresh/server.ts&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>twindPlugin</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;$fresh/plugins/twind.ts&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>twindConfig</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;./twind.config.ts&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>defineConfig</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>twindPlugin</span>(<span style=color:#a6e22e>twindConfig</span>)],
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>build</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>outDir</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;./dist&#34;</span>,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h3 id=esbuildのターゲットのカスタマイズ-buildtarget>esbuildのターゲットのカスタマイズ (<code>build.target</code>)<a hidden class=anchor aria-hidden=true href=#esbuildのターゲットのカスタマイズ-buildtarget>#</a></h3><p><a href="https://deno.land/x/fresh@1.5.0/server.ts?doc=&s=FreshOptions">FreshOptions</a>に<code>build.target</code>オプションが追加されています。</p><p>これによりesbuildの<code>target</code>オプションをカスタマイズできます</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span><span style=color:#75715e>// fresh.config.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>defineConfig</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>twindPlugin</span>(<span style=color:#a6e22e>twindConfig</span>)],
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>build</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>target</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;es2020&#34;</span>],
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h3 id=無視したいルートファイルのパターンの指定がサポート-routerignorefilepattern>無視したいルートファイルのパターンの指定がサポート (<code>router.ignoreFilePattern</code>)<a hidden class=anchor aria-hidden=true href=#無視したいルートファイルのパターンの指定がサポート-routerignorefilepattern>#</a></h3><p><code>router.ignoreFilePattern</code>オプションが追加されました。<code>routes/</code>配下において無視したいファイルのパターンを指定できます。</p><p>デフォルトでは、<code>routes</code>配下のテストファイル(<code>*.test.ts</code>など)が無視されるよう設定されています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span><span style=color:#75715e>// fresh.config.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>defineConfig</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>twindPlugin</span>(<span style=color:#a6e22e>twindConfig</span>)],
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>router</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 例) `*.spec.ts(x)`ファイルを無視する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ignoreFilePattern</span><span style=color:#f92672>:</span> <span style=color:#e6db74>/\.spec\.(?:ts|tsx)$/</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h3 id=サーバーに関する設定のカスタマイズがサポート-freshoptionsserver>サーバーに関する設定のカスタマイズがサポート (<code>FreshOptions.server</code>)<a hidden class=anchor aria-hidden=true href=#サーバーに関する設定のカスタマイズがサポート-freshoptionsserver>#</a></h3><p><code>server</code>オプションによってfreshの起動ポートなどをカスタマイズできます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span><span style=color:#75715e>// fresh.config.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>defineConfig</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>twindPlugin</span>(<span style=color:#a6e22e>twindConfig</span>)],
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>server</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>port</span>: <span style=color:#66d9ef>3000</span>,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><hr><h2 id=サーバー>サーバー<a hidden class=anchor aria-hidden=true href=#サーバー>#</a></h2><h3 id=オプショナルなダイナミックルートパラメータ>オプショナルなダイナミックルートパラメータ<a hidden class=anchor aria-hidden=true href=#オプショナルなダイナミックルートパラメータ>#</a></h3><p><code>[[name]]</code>のような形式でオプショナルなダイナミックルートパラメータを定義できるようになりました。</p><p>例えば、<code>routes/docs/[[version]]/index.tsx</code>を用意しておくと、以下のいずれかのパターンにマッチします。</p><ul><li><code>/docs/v1</code></li><li><code>/docs/</code></li></ul><h3 id=非islandコンポーネントでのフックの使用について>非Islandコンポーネントでのフックの使用について<a hidden class=anchor aria-hidden=true href=#非islandコンポーネントでのフックの使用について>#</a></h3><p>非Islandコンポーネントで<code>useState</code>または<code>useReducer</code>を使用した際に、以下のようなエラーが発生するように改善されました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Error: Hook <span style=color:#e6db74>&#34;useState&#34;</span> cannot be used outside of an island component.
</span></span></code></pre></div><hr><h2 id=その他の改善点>その他の改善点<a hidden class=anchor aria-hidden=true href=#その他の改善点>#</a></h2><h3 id=デフォルトのエラーページの改善>デフォルトのエラーページの改善<a hidden class=anchor aria-hidden=true href=#デフォルトのエラーページの改善>#</a></h3><p>開発時にエラーが発生した際のデフォルトのエラーページが改善されました。</p><p>以下のようにエラーが発生した箇所とその周辺のソースコードが表示されます。</p><pre tabindex=0><code>エラーメッセージ
   5 | export default function Home() {
   6 |   const count = useSignal(3);
&gt;  7 |   throw new Error(&#34;エラーメッセージ&#34;);
     |         ^
   8 |   return (
   9 |     &lt;&gt;
  10 |       &lt;Head&gt;
</code></pre><h3 id=インラインのscriptへのnonceの付与>インラインの<code>&lt;script></code>への<code>nonce</code>の付与<a hidden class=anchor aria-hidden=true href=#インラインのscriptへのnonceの付与>#</a></h3><p>以下のようなインラインの<code>&lt;script></code>にも<code>nonce</code>が付与されるように改善されました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>dangerouslySetInnerHTML</span><span style=color:#f92672>=</span>{{ <span style=color:#a6e22e>__html</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;alert(&#39;hi&#39;)&#34;</span> }} /&gt;
</span></span></code></pre></div><h3 id=head配下の要素でのkeyのサポートについて><code>&lt;Head></code>配下の要素での<code>key</code>のサポートについて<a hidden class=anchor aria-hidden=true href=#head配下の要素でのkeyのサポートについて>#</a></h3><p>以下のように同一ページで複数回<code>&lt;Head></code>が使用された際に、重複したタグが出力される問題を修正することが目的のようです</p><p>例えば、以下のように<code>name</code>が重複した<code>&lt;meta></code>が複数回宣言されていたとします。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>Head</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;og:title&#34;</span> <span style=color:#a6e22e>content</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;foo&#34;</span> /&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>Head</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>Head</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;og:title&#34;</span> <span style=color:#a6e22e>content</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;bar&#34;</span> /&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>Head</span>&gt;
</span></span></code></pre></div><p>この場合、freshは<code>&lt;head></code>タグ配下に以下のような<code>&lt;meta></code>タグを生成します。</p><pre tabindex=0><code>&lt;meta name=&#34;og:title&#34; content=&#34;foo&#34; /&gt;
&lt;meta name=&#34;og:title&#34; content=&#34;bar&#34; /&gt;
</code></pre><p>こういった場合、<code>&lt;meta></code>に<code>key</code>属性を指定することで重複を取り除くことができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>Head</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;og:title&#34;</span> <span style=color:#a6e22e>content</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;foo&#34;</span> <span style=color:#a6e22e>key</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;title&#34;</span> /&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>Head</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>Head</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;og:title&#34;</span> <span style=color:#a6e22e>content</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;bar&#34;</span> <span style=color:#a6e22e>key</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;title&#34;</span> /&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>Head</span>&gt;
</span></span></code></pre></div><p>この場合、<code>&lt;head></code>タグ配下には以下のように<code>&lt;meta></code>タグが生成されます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;og:title&#34;</span> <span style=color:#a6e22e>content</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;bar&#34;</span> /&gt;
</span></span></code></pre></div><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li><a href=https://github.com/denoland/fresh/releases/tag/1.5.0>https://github.com/denoland/fresh/releases/tag/1.5.0</a></li><li><a href=https://deno.com/blog/fresh-1.5>Fresh 1.5: Partials, client side navigation and more</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://uki00a.github.io/deno-weekly/tags/fresh.html>fresh</a></li><li><a href=https://uki00a.github.io/deno-weekly/tags/preact.html>Preact</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://uki00a.github.io/deno-weekly/>週刊Deno</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>