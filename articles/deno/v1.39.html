<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Deno v1.39 | 週刊Deno</title><meta name=keywords content="Deno,Deno KV,Deno Cron"><meta name=description content="WebGPU APIの再導入, deno coverageでHTMLレポーターがサポート, Deno.cronでオブジェクト形式でのスケジューリングがサポート, Deno.Kvのenqueueでリトライポリシーをカスタマイズできるように, deno compileでBYONMがサポート, sloppy importsのサポートなど, TypeScript v5.3へのアップデート, など"><meta name=author content><link rel=canonical href=https://uki00a.github.io/deno-weekly/articles/deno/v1.39.html><link crossorigin=anonymous href=/deno-weekly/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/deno-weekly/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://raw.githubusercontent.com/uki00a/blog/master/src/assets/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://uki00a.github.io/deno-weekly/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://uki00a.github.io/deno-weekly/favicon-32x32.png><link rel=apple-touch-icon href=https://uki00a.github.io/deno-weekly/apple-touch-icon.png><link rel=mask-icon href=https://uki00a.github.io/deno-weekly/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:image" content="https://raw.githubusercontent.com/uki00a/blog/master/src/assets/avatar.png"><meta property="twitter:image" content="https://raw.githubusercontent.com/uki00a/blog/master/src/assets/avatar.png"><meta name=twitter:site content="@uki00a"><script async src="https://www.googletagmanager.com/gtag/js?id=G-MK2K2MRMBF"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-MK2K2MRMBF",{anonymize_ip:!1})}</script><meta property="og:title" content="Deno v1.39"><meta property="og:description" content="WebGPU APIの再導入, deno coverageでHTMLレポーターがサポート, Deno.cronでオブジェクト形式でのスケジューリングがサポート, Deno.Kvのenqueueでリトライポリシーをカスタマイズできるように, deno compileでBYONMがサポート, sloppy importsのサポートなど, TypeScript v5.3へのアップデート, など"><meta property="og:type" content="article"><meta property="og:url" content="https://uki00a.github.io/deno-weekly/articles/deno/v1.39.html"><meta property="article:section" content="articles"><meta property="article:published_time" content="2023-12-17T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-17T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deno v1.39"><meta name=twitter:description content="WebGPU APIの再導入, deno coverageでHTMLレポーターがサポート, Deno.cronでオブジェクト形式でのスケジューリングがサポート, Deno.Kvのenqueueでリトライポリシーをカスタマイズできるように, deno compileでBYONMがサポート, sloppy importsのサポートなど, TypeScript v5.3へのアップデート, など"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Deno v1.39","item":"https://uki00a.github.io/deno-weekly/articles/deno/v1.39.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Deno v1.39","name":"Deno v1.39","description":"WebGPU APIの再導入, deno coverageでHTMLレポーターがサポート, Deno.cronでオブジェクト形式でのスケジューリングがサポート, Deno.Kvのenqueueでリトライポリシーをカスタマイズできるように, deno compileでBYONMがサポート, sloppy importsのサポートなど, TypeScript v5.3へのアップデート, など","keywords":["Deno","Deno KV","Deno Cron"],"articleBody":"Deno v1.39がリリースされました。\nこの記事では主な変更点などについて解説します。\nWebGPU APIの再導入 Deno v1.32で削除されたWebGPU APIが再導入されました。\n利用するにはdeno.jsonでunstable: [\"webgpu\"]を指定するか--unstable-webgpuオプションの指定が必要です。\n{  \"unstable\": [\"webgpu\"] } 以下のリポジトリではWebGPU APIに関する使用例が公開されています。\n https://github.com/denoland/webgpu-examples  また、この追加に合わせて、deno_stdにもWebGPU API向けのユーティリティが追加されています。(std/webgpu)\ndeno coverage サマリー/HTMLレポーターの追加 deno coverageコマンドにサマリーレポーターとHTMLレポーターが追加されました。\nサマリーレポーターは新しくdeno coverageコマンドのデフォルトで使用されるレポーターとして設定されていて、以下のような形式でレポートが出力されます。\n$ deno coverage ./coverage ----------------------------------------------------------- File | Branch % | Line % | -----------------------------------------------------------  demo/components/Button.tsx | 100.0 | 0.0 |  demo/fresh.gen.ts | 100.0 | 100.0 |  ... 省略 ...  internal/test_utils/mod.ts | 100.0 | 100.0 |  server.ts | 83.3 | 90.3 | -----------------------------------------------------------  All files | 82.2 | 72.3 | もしDeno v1.38以前の形式でレポートを出力したい場合は、--detailedオプションを指定する必要があります。\n$ deno coverage --detailed ./coverage もう一つのHTMLレポーターはカバレッジレポートをHTML形式で出力してくれます。deno test --coverageが生成したディレクトリ内にhtml/index.htmlを生成してくれるため、ブラウザなどで閲覧することができます。\n$ deno coverage --html ./coverage HTML coverage report has been generated at file:///path/to/project/coverage/html/index.html  $ xdg-open coverage/html/index.html deno test: --coverageオプションにデフォルト値が設定 今まではdeno test --coverageでカバレッジ情報を出力する際はディレクトリを明示する必要がありました。\n# ./covディレクトリにカバレッジ情報を出力します。 $ deno test --coverage=cov/ -A ./server.test.ts Deno v1.39では--coverageオプションへのディレクトリの指定を省略できるようになりました。\nディレクトリを省略した場合は、デフォルトで./coverage/にカバレッジ情報が出力されます。\nDeno Cron オブジェクト形式でのスケジュールの設定がサポート Deno.cronでオブジェクトによるスケジュールの指定がサポートされました。(Deno.CronSchedule)\n例えば、3分ごとに特定の処理を実行したい場合、今までは以下のように記述する必要がありました。\nDeno.cron(\"sample\", \"*/3 * * * *\", () = doSomething()); 上記と同様に設定したい場合、以下のような記述ができます。\nDeno.cron(  \"sample\",  { minute: { every: 3 } },  () = doSomething(), ); Deno KV enqueue()メソッドでbackoffScheduleオプションがサポート リトライポリシーのカスタマイズに利用できます。\nconst db = await Deno.openKv(\":memory:\"); // ... await db.enqueue(\"message\", {  // 最大で3回リトライを行うように指定しています。  // ここではリトライ間隔を100ms - 200ms - 400msと指定しています。  backoffSchedule: [100, 200, 400], }); backoffScheduleオプションには最大で5つまで要素を指定することができます。(最大リトライ回数は5回)\nまた、各要素に指定できる値の最大値は3600000です。(1回のリトライあたりの最大待機時間は最大で1時間)\n https://github.com/denoland/deno/pull/21474\ncommitVersionstampメソッドの追加 Deno.KvにcommitVersionstampメソッドが実装されています。\nこのメソッドが返す値をキーの最後の要素として指定することができて、その場合、その位置には自動でバージョンスタンプが設定されます。\nconst db = await Deno.openKv(\":memory:\");  const result = await db.set([\"entries\", db.commitVersionstamp()], \"foobar\"); assert(result.ok); const found = await db.get([\"entries\", result.versionstamp]); assert(found.value === \"foobar\"); Deno.serve Deno.HttpServer#shutdownの安定化 HTTPサーバーをgracefulに停止するためのAPIであるDeno.HttpServer#shutdownが安定化されました。\n今後は--unstableの指定なしで利用できます。\nUnixドメインソケットサポートの安定化 Deno v1.37.2で実装されたDeno.serve()のUnixドメインソケットサポートが安定化されています。\n※APIについては安定化されたものの、v1.39.0においてはまだ--unstableの指定が必要なようで、おそらく次のv1.39.1で正式に--unstableの指定が不要になりそうです。\n fix(net): remove unstable check for unix socket listen #21592\n  追記) Deno v1.39.1で安定化されました。\nDeno.HttpClient usingのサポート Deno.HttpClientがusingに対応しました。\n// スコープから抜ける際に自動で`Deno.HttpClient#close()`を呼んでくれます。 using client = Deno.createHttpClient({ allowHost: true }); const res = await fetch(\"http://localhost:3000/\", {  client,  headers: { host: \"example.com\" }, }); deno compile BYONMがサポート Deno v1.38で実装されたBYONMがdeno compileコマンドでもサポートされました。これにより、Node.jsで実装されたCLIプログラムからスタンドアロンの実行可能ファイルを生成できる余地が生まれそうです。\n$ npm i chalk@5.3.0  $ cat index.js import chalk from 'chalk';  console.info(chalk.bold(chalk.green('foobar')));   $ deno compile --unstable-byonm --output=sample index.js Compile file:///path/to/project/index.js to sample  $ ./sample foobar dynamic importの挙動の改善 deno compileで以下のように動的にimport()の引数を作成しているケースがサポートされました。\nawait import(`./subdir/${target}`); また、上記の場合、./subdir配下やその子孫のディレクトリからもモジュールを探して、それらも最終的なバイナリに含めることで、より安定して動作できるよう改善が図られているようです。\nWeb API ReadableStreamBYOBReader#readでminオプションが実装 ReadableStreamBYOBReader#readでminオプションがサポートされています。\nこのオプションを指定すると、minで指定された要素数が読み込まれるまでresolveされないように制御できるようです。\n  Add ReadableStreamBYOBReader.prototype.read(view, { min }) (whatwg/streams#1145)\n URLPatternのパフォーマンス改善 URLPatternについて、主にフレームワークなどのrouterとして使用されるケースを想定したパフォーマンス改善が実施されています。\n perf(ext/url): improve URLPattern perf #21488\n おそらくこの修正に合わせて、fresh v1.6.1でもRegExpからURLPatternを使用してマッチングをするように修正されているようです。\nImageDataが実装 ImageDataがサポートされています。\nsloppy importsのサポート (--unstable-sloppy-imports) --unstable-sloppy-importsオプションが追加されました。\nこのオプションまたはdeno.jsonでunstable: [\"sloppy-imports\"]を指定すると、以下のようなimportが有効化されます。\n// (1) 拡張子なしでのimport import { add } from './add';  // (2) ディレクトリを指定したimport import { foo } from './subdir';  // (3) `.ts`モジュールを`.js`拡張子でimport import { sleep } from './subdir/sleep.js'; この機能はNode.jsで書かれたプログラムをDenoで動かしやすくするために導入された機能のようで、Denoの一般的な使用においては指定することは推奨されないようです。実際に使用すると、以下のような警告が表示されます。\nWarning Sloppy imports are not recommended and have a negative impact on performance. これに合わせて、deno lspでもsloppy-imports向けのQuickfixがサポートされています。\nObject.prototype.__proto__の有効化 (--unstable-unsafe-proto) --unstable-unsafe-protoオプションが実装されました。\nセキュリティのためDenoはデフォルトでObject.prototype.__proto__を削除します。deno.jsonでunstable: [\"unsafe-proto\"]を設定するか、または--unstable-unsafe-protoオプションを指定することで、この挙動を無効化できます。\n一部のnpmパッケージを動かすためにObject.prototype.__proto__が欲しい場面での使用が想定されています。\ndeno lsp デバッグ向けのログ出力がサポート ワークスペースで\"deno.logFile\": trueを指定しておくと、.deno_lsp/log_{timestamp}.txtにログを出力してくれます。\n// .vscode/settings.json {  // ...  \"deno.logFile\": true } \"deno.internalDebug\": trueと併用することで、より多くの情報が閲覧できるようです。\ndeno fmt .ipynbがサポート Deno v1.37でのdeno jupyterの実装に合わせて、deno fmtでも.ipynbファイルをフォーマットできるようになりました。\nTypeScript v5.3 Denoの内部に搭載されているTypeScriptがv5.3へアップデートされました。\nDeno v1.40での計画について Deno v1.39の時点ではexperimentalDecoratorsがデフォルトで有効化されています。\nv1.39の公式ブログによると、Deno v1.40でこのデフォルトの挙動を変更し、TC39 decoratorsの方をデフォルトで有効化することが検討されているようです。\nそのため、もしexperimentalDecoratorsを使っている場合は、今のうちにdeno.jsonで\"compilerOptions.experimentalDecorators\": trueを設定しておき、明示的に有効化しておくと安全なようです。\nNode.js互換性の改善 今回のリリースでも様々な改善が実施されています。\ndeno taskでnode_modules/.binの探索がサポート package.jsonのscriptsで定義されたスクリプトをdeno taskで実行する際に、node_modules/.binに配置された実行可能ファイルを探索してくれるように改善されました。\n組み込みモジュールの改善  node:child_process: fork()が実装されています。 node:util: parseArgs()が実装されています。 node:vm: runInNewContext()が実装されています。(optionsはまだサポートされていないようです)  Webpack(+Next.js)の動作に向けた対応のようです (#21527)   node:os: freemem()の互換性の向上  LinuxではDeno.SystemMemoryInfo.available、それ以外の環境ではDeno.SystemMemoryInfo.freeと同じ値が返されるように挙動が変更されているようです。   node:crypto: sign()でPEM形式の秘密鍵がサポート node:process: process.exitCodeの設定値がDenoによって認識されるように改善されています。  その他  Deno.ChildProcessの型定義でAsyncDisposableではなくDisposableが実装されていた問題が修正されています。 --allow-net=localhost:80のようにホスト名と80番ポートを許可すると、対象ホストの全ポートへのアクセスが許可されてしまう問題が修正されています。 Deno.permissions.revokeでnetパーミッションを拒否しようとすると、プロセスがパニックする問題が修正されています。  参考  https://github.com/denoland/deno/releases/tag/v1.39.0 Deno 1.39: The Return of WebGPU  ","wordCount":"429","inLanguage":"en","datePublished":"2023-12-17T00:00:00Z","dateModified":"2023-12-17T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://uki00a.github.io/deno-weekly/articles/deno/v1.39.html"},"publisher":{"@type":"Organization","name":"週刊Deno","logo":{"@type":"ImageObject","url":"https://raw.githubusercontent.com/uki00a/blog/master/src/assets/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://uki00a.github.io/deno-weekly/ accesskey=h title="週刊Deno (Alt + H)">週刊Deno</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://uki00a.github.io/deno-weekly/tags.html title=タグ><span><i class="fa fa-heart"></i>タグ</span></a></li><li><a href=https://uki00a.github.io/deno-weekly/categories.html title=カテゴリー><span><i class="fa fa-heart"></i>カテゴリー</span></a></li><li><a href=https://uki00a.github.io/deno-weekly/gallery.html title=ギャラリー><span><i class="fa fa-road"></i>ギャラリー<span class=alert></span></span></a></li><li><a href=https://uki00a.github.io/deno-weekly/index.xml title="RSS feed"><span><i class="fa fa-road"></i>RSS feed<span class=alert></span></span></a></li><li><a href=https://uki00a.github.io/deno-weekly/about.html title=About><span><i class="fa fa-road"></i>About<span class=alert></span></span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Deno v1.39</h1><div class=post-description>WebGPU APIの再導入, deno coverageでHTMLレポーターがサポート, Deno.cronでオブジェクト形式でのスケジューリングがサポート, Deno.Kvのenqueueでリトライポリシーをカスタマイズできるように, deno compileでBYONMがサポート, sloppy importsのサポートなど, TypeScript v5.3へのアップデート, など</div><div class=post-meta><span title="2023-12-17 00:00:00 +0000 UTC">December 17, 2023</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#webgpu-api%e3%81%ae%e5%86%8d%e5%b0%8e%e5%85%a5 aria-label="WebGPU APIの再導入">WebGPU APIの再導入</a></li><li><a href=#deno-coverage aria-label="deno coverage"><code>deno coverage</code></a><ul><li><a href=#%e3%82%b5%e3%83%9e%e3%83%aa%e3%83%bchtml%e3%83%ac%e3%83%9d%e3%83%bc%e3%82%bf%e3%83%bc%e3%81%ae%e8%bf%bd%e5%8a%a0 aria-label=サマリー/HTMLレポーターの追加>サマリー/HTMLレポーターの追加</a></li><li><a href=#deno-test---coverage%e3%82%aa%e3%83%97%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%ab%e3%83%87%e3%83%95%e3%82%a9%e3%83%ab%e3%83%88%e5%80%a4%e3%81%8c%e8%a8%ad%e5%ae%9a aria-label="deno test: --coverageオプションにデフォルト値が設定"><code>deno test</code>: <code>--coverage</code>オプションにデフォルト値が設定</a></li></ul></li><li><a href=#deno-cron aria-label="Deno Cron">Deno Cron</a><ul><li><a href=#%e3%82%aa%e3%83%96%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e5%bd%a2%e5%bc%8f%e3%81%a7%e3%81%ae%e3%82%b9%e3%82%b1%e3%82%b8%e3%83%a5%e3%83%bc%e3%83%ab%e3%81%ae%e8%a8%ad%e5%ae%9a%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=オブジェクト形式でのスケジュールの設定がサポート>オブジェクト形式でのスケジュールの設定がサポート</a></li></ul></li><li><a href=#deno-kv aria-label="Deno KV">Deno KV</a><ul><li><a href=#enqueue%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%81%a7backoffschedule%e3%82%aa%e3%83%97%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=enqueue()メソッドでbackoffScheduleオプションがサポート><code>enqueue()</code>メソッドで<code>backoffSchedule</code>オプションがサポート</a></li><li><a href=#commitversionstamp%e3%83%a1%e3%82%bd%e3%83%83%e3%83%89%e3%81%ae%e8%bf%bd%e5%8a%a0 aria-label=commitVersionstampメソッドの追加><code>commitVersionstamp</code>メソッドの追加</a></li></ul></li><li><a href=#denoserve aria-label=Deno.serve><code>Deno.serve</code></a><ul><li><a href=#denohttpservershutdown%e3%81%ae%e5%ae%89%e5%ae%9a%e5%8c%96 aria-label=Deno.HttpServer#shutdownの安定化><code>Deno.HttpServer#shutdown</code>の安定化</a></li><li><a href=#unix%e3%83%89%e3%83%a1%e3%82%a4%e3%83%b3%e3%82%bd%e3%82%b1%e3%83%83%e3%83%88%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88%e3%81%ae%e5%ae%89%e5%ae%9a%e5%8c%96 aria-label=Unixドメインソケットサポートの安定化>Unixドメインソケットサポートの安定化</a></li></ul></li><li><a href=#denohttpclient aria-label=Deno.HttpClient><code>Deno.HttpClient</code></a><ul><li><a href=#using%e3%81%ae%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=usingのサポート><code>using</code>のサポート</a></li></ul></li><li><a href=#deno-compile aria-label="deno compile"><code>deno compile</code></a><ul><li><a href=#byonm%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=BYONMがサポート>BYONMがサポート</a></li><li><a href=#dynamic-import%e3%81%ae%e6%8c%99%e5%8b%95%e3%81%ae%e6%94%b9%e5%96%84 aria-label="dynamic importの挙動の改善">dynamic importの挙動の改善</a></li></ul></li><li><a href=#web-api aria-label="Web API">Web API</a><ul><li><a href=#readablestreambyobreaderread%e3%81%a7min%e3%82%aa%e3%83%97%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%8c%e5%ae%9f%e8%a3%85 aria-label=ReadableStreamBYOBReader#readでminオプションが実装><code>ReadableStreamBYOBReader#read</code>で<code>min</code>オプションが実装</a></li><li><a href=#urlpattern%e3%81%ae%e3%83%91%e3%83%95%e3%82%a9%e3%83%bc%e3%83%9e%e3%83%b3%e3%82%b9%e6%94%b9%e5%96%84 aria-label=URLPatternのパフォーマンス改善>URLPatternのパフォーマンス改善</a></li><li><a href=#imagedata%e3%81%8c%e5%ae%9f%e8%a3%85 aria-label=ImageDataが実装><code>ImageData</code>が実装</a></li></ul></li><li><a href=#sloppy-imports%e3%81%ae%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88---unstable-sloppy-imports aria-label="sloppy importsのサポート (--unstable-sloppy-imports)">sloppy importsのサポート (<code>--unstable-sloppy-imports</code>)</a></li><li><a href=#objectprototype__proto__%e3%81%ae%e6%9c%89%e5%8a%b9%e5%8c%96---unstable-unsafe-proto aria-label="Object.prototype.__proto__の有効化 (--unstable-unsafe-proto)"><code>Object.prototype.__proto__</code>の有効化 (<code>--unstable-unsafe-proto</code>)</a></li><li><a href=#deno-lsp aria-label="deno lsp"><code>deno lsp</code></a><ul><li><a href=#%e3%83%87%e3%83%90%e3%83%83%e3%82%b0%e5%90%91%e3%81%91%e3%81%ae%e3%83%ad%e3%82%b0%e5%87%ba%e5%8a%9b%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=デバッグ向けのログ出力がサポート>デバッグ向けのログ出力がサポート</a></li></ul></li><li><a href=#deno-fmt aria-label="deno fmt"><code>deno fmt</code></a><ul><li><a href=#ipynb%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=.ipynbがサポート><code>.ipynb</code>がサポート</a></li></ul></li><li><a href=#typescript-v53 aria-label="TypeScript v5.3">TypeScript v5.3</a><ul><li><a href=#deno-v140%e3%81%a7%e3%81%ae%e8%a8%88%e7%94%bb%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6 aria-label="Deno v1.40での計画について">Deno v1.40での計画について</a></li></ul></li><li><a href=#nodejs%e4%ba%92%e6%8f%9b%e6%80%a7%e3%81%ae%e6%94%b9%e5%96%84 aria-label=Node.js互換性の改善>Node.js互換性の改善</a><ul><li><a href=#deno-task%e3%81%a7node_modulesbin%e3%81%ae%e6%8e%a2%e7%b4%a2%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label="deno taskでnode_modules/.binの探索がサポート"><code>deno task</code>で<code>node_modules/.bin</code>の探索がサポート</a></li><li><a href=#%e7%b5%84%e3%81%bf%e8%be%bc%e3%81%bf%e3%83%a2%e3%82%b8%e3%83%a5%e3%83%bc%e3%83%ab%e3%81%ae%e6%94%b9%e5%96%84 aria-label=組み込みモジュールの改善>組み込みモジュールの改善</a></li></ul></li><li><a href=#%e3%81%9d%e3%81%ae%e4%bb%96 aria-label=その他>その他</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div><div class=post-content><p>Deno v1.39がリリースされました。</p><p>この記事では主な変更点などについて解説します。</p><h2 id=webgpu-apiの再導入>WebGPU APIの再導入<a hidden class=anchor aria-hidden=true href=#webgpu-apiの再導入>#</a></h2><p><a href=https://uki00a.github.io/deno-weekly/articles/deno/v1.32.html>Deno v1.32</a>で削除された<a href=https://developer.mozilla.org/en-US/docs/Web/API/WebGPU_API>WebGPU API</a>が再導入されました。</p><p>利用するには<code>deno.json</code>で<code>unstable: ["webgpu"]</code>を指定するか<code>--unstable-webgpu</code>オプションの指定が必要です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;unstable&#34;</span>: [<span style=color:#e6db74>&#34;webgpu&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>以下のリポジトリではWebGPU APIに関する使用例が公開されています。</p><ul><li><a href=https://github.com/denoland/webgpu-examples>https://github.com/denoland/webgpu-examples</a></li></ul><p>また、この追加に合わせて、<code>deno_std</code>にもWebGPU API向けのユーティリティが追加されています。(<a href=https://deno.land/std@0.209.0/webgpu>std/webgpu</a>)</p><h2 id=deno-coverage><code>deno coverage</code><a hidden class=anchor aria-hidden=true href=#deno-coverage>#</a></h2><h3 id=サマリーhtmlレポーターの追加>サマリー/HTMLレポーターの追加<a hidden class=anchor aria-hidden=true href=#サマリーhtmlレポーターの追加>#</a></h3><p><code>deno coverage</code>コマンドにサマリーレポーターとHTMLレポーターが追加されました。</p><p>サマリーレポーターは新しく<code>deno coverage</code>コマンドのデフォルトで使用されるレポーターとして設定されていて、以下のような形式でレポートが出力されます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ deno coverage ./coverage
</span></span><span style=display:flex><span>-----------------------------------------------------------
</span></span><span style=display:flex><span>File                                  | Branch % | Line % |
</span></span><span style=display:flex><span>-----------------------------------------------------------
</span></span><span style=display:flex><span> demo/components/Button.tsx           |    100.0 |    0.0 |
</span></span><span style=display:flex><span> demo/fresh.gen.ts                    |    100.0 |  100.0 |
</span></span><span style=display:flex><span>   ... 省略 ...
</span></span><span style=display:flex><span> internal/test_utils/mod.ts           |    100.0 |  100.0 |
</span></span><span style=display:flex><span> server.ts                            |     83.3 |   90.3 |
</span></span><span style=display:flex><span>-----------------------------------------------------------
</span></span><span style=display:flex><span> All files                            |     82.2 |   72.3 |
</span></span></code></pre></div><p>もしDeno v1.38以前の形式でレポートを出力したい場合は、<code>--detailed</code>オプションを指定する必要があります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ deno coverage --detailed ./coverage
</span></span></code></pre></div><p>もう一つのHTMLレポーターはカバレッジレポートをHTML形式で出力してくれます。<code>deno test --coverage</code>が生成したディレクトリ内に<code>html/index.html</code>を生成してくれるため、ブラウザなどで閲覧することができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ deno coverage --html ./coverage
</span></span><span style=display:flex><span>HTML coverage report has been generated at file:///path/to/project/coverage/html/index.html
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ xdg-open coverage/html/index.html
</span></span></code></pre></div><h3 id=deno-test---coverageオプションにデフォルト値が設定><code>deno test</code>: <code>--coverage</code>オプションにデフォルト値が設定<a hidden class=anchor aria-hidden=true href=#deno-test---coverageオプションにデフォルト値が設定>#</a></h3><p>今までは<code>deno test --coverage</code>でカバレッジ情報を出力する際はディレクトリを明示する必要がありました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># ./covディレクトリにカバレッジ情報を出力します。</span>
</span></span><span style=display:flex><span>$ deno test --coverage<span style=color:#f92672>=</span>cov/ -A ./server.test.ts
</span></span></code></pre></div><p>Deno v1.39では<code>--coverage</code>オプションへのディレクトリの指定を省略できるようになりました。</p><p>ディレクトリを省略した場合は、デフォルトで<code>./coverage/</code>にカバレッジ情報が出力されます。</p><h2 id=deno-cron>Deno Cron<a hidden class=anchor aria-hidden=true href=#deno-cron>#</a></h2><h3 id=オブジェクト形式でのスケジュールの設定がサポート>オブジェクト形式でのスケジュールの設定がサポート<a hidden class=anchor aria-hidden=true href=#オブジェクト形式でのスケジュールの設定がサポート>#</a></h3><p><a href="https://deno.land/api@v1.39.0?s=Deno.cron&unstable="><code>Deno.cron</code></a>でオブジェクトによるスケジュールの指定がサポートされました。(<a href="https://deno.land/api@v1.39.0?s=Deno.CronSchedule&unstable="><code>Deno.CronSchedule</code></a>)</p><p>例えば、3分ごとに特定の処理を実行したい場合、今までは以下のように記述する必要がありました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Deno</span>.<span style=color:#a6e22e>cron</span>(<span style=color:#e6db74>&#34;sample&#34;</span>, <span style=color:#e6db74>&#34;*/3 * * * *&#34;</span>, () =&gt; <span style=color:#a6e22e>doSomething</span>());
</span></span></code></pre></div><p>上記と同様に設定したい場合、以下のような記述ができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>Deno</span>.<span style=color:#a6e22e>cron</span>(
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;sample&#34;</span>,
</span></span><span style=display:flex><span>  { <span style=color:#a6e22e>minute</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>every</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3</span> } },
</span></span><span style=display:flex><span>  () =&gt; <span style=color:#a6e22e>doSomething</span>(),
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><h2 id=deno-kv>Deno KV<a hidden class=anchor aria-hidden=true href=#deno-kv>#</a></h2><h3 id=enqueueメソッドでbackoffscheduleオプションがサポート><code>enqueue()</code>メソッドで<code>backoffSchedule</code>オプションがサポート<a hidden class=anchor aria-hidden=true href=#enqueueメソッドでbackoffscheduleオプションがサポート>#</a></h3><p>リトライポリシーのカスタマイズに利用できます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Deno</span>.<span style=color:#a6e22e>openKv</span>(<span style=color:#e6db74>&#34;:memory:&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>enqueue</span>(<span style=color:#e6db74>&#34;message&#34;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 最大で3回リトライを行うように指定しています。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// ここではリトライ間隔を100ms -&gt; 200ms -&gt; 400msと指定しています。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>backoffSchedule</span><span style=color:#f92672>:</span> [<span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>200</span>, <span style=color:#ae81ff>400</span>],
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p><code>backoffSchedule</code>オプションには最大で5つまで要素を指定することができます。(最大リトライ回数は5回)</p><p>また、各要素に指定できる値の最大値は<code>3600000</code>です。(1回のリトライあたりの最大待機時間は最大で1時間)</p><hr><p><a href=https://github.com/denoland/deno/pull/21474>https://github.com/denoland/deno/pull/21474</a></p><h3 id=commitversionstampメソッドの追加><code>commitVersionstamp</code>メソッドの追加<a hidden class=anchor aria-hidden=true href=#commitversionstampメソッドの追加>#</a></h3><p><code>Deno.Kv</code>に<a href="https://deno.land/api@v1.39.0?s=Deno.Kv&unstable=&p=prototype.commitVersionstamp">commitVersionstamp</a>メソッドが実装されています。</p><p>このメソッドが返す値をキーの最後の要素として指定することができて、その場合、その位置には自動でバージョンスタンプが設定されます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Deno</span>.<span style=color:#a6e22e>openKv</span>(<span style=color:#e6db74>&#34;:memory:&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>set</span>([<span style=color:#e6db74>&#34;entries&#34;</span>, <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>commitVersionstamp</span>()], <span style=color:#e6db74>&#34;foobar&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>assert</span>(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>ok</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>found</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>get</span>([<span style=color:#e6db74>&#34;entries&#34;</span>, <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>versionstamp</span>]);
</span></span><span style=display:flex><span><span style=color:#a6e22e>assert</span>(<span style=color:#a6e22e>found</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;foobar&#34;</span>);
</span></span></code></pre></div><h2 id=denoserve><code>Deno.serve</code><a hidden class=anchor aria-hidden=true href=#denoserve>#</a></h2><h3 id=denohttpservershutdownの安定化><code>Deno.HttpServer#shutdown</code>の安定化<a hidden class=anchor aria-hidden=true href=#denohttpservershutdownの安定化>#</a></h3><p>HTTPサーバーをgracefulに停止するためのAPIである<a href="https://deno.land/api@v1.39.0?s=Deno.HttpServer#method_shutdown_2">Deno.HttpServer#shutdown</a>が安定化されました。</p><p>今後は<code>--unstable</code>の指定なしで利用できます。</p><h3 id=unixドメインソケットサポートの安定化>Unixドメインソケットサポートの安定化<a hidden class=anchor aria-hidden=true href=#unixドメインソケットサポートの安定化>#</a></h3><p><a href=https://uki00a.github.io/deno-weekly/articles/2023/10/15.html>Deno v1.37.2</a>で実装された<code>Deno.serve()</code>のUnixドメインソケットサポートが安定化されています。</p><p>※APIについては安定化されたものの、v1.39.0においてはまだ<code>--unstable</code>の指定が必要なようで、おそらく次のv1.39.1で正式に<code>--unstable</code>の指定が不要になりそうです。</p><blockquote><p><a href=https://github.com/denoland/deno/pull/21592>fix(net): remove unstable check for unix socket listen #21592</a></p></blockquote><hr><p>追記) <a href=https://uki00a.github.io/deno-weekly/articles/2023/12/24.html>Deno v1.39.1</a>で安定化されました。</p><h2 id=denohttpclient><code>Deno.HttpClient</code><a hidden class=anchor aria-hidden=true href=#denohttpclient>#</a></h2><h3 id=usingのサポート><code>using</code>のサポート<a hidden class=anchor aria-hidden=true href=#usingのサポート>#</a></h3><p><a href="https://deno.land/api@v1.39.0?s=Deno.HttpClient&unstable=">Deno.HttpClient</a>が<code>using</code>に対応しました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// スコープから抜ける際に自動で`Deno.HttpClient#close()`を呼んでくれます。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>using</span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Deno</span>.<span style=color:#a6e22e>createHttpClient</span>({ <span style=color:#a6e22e>allowHost</span>: <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#34;http://localhost:3000/&#34;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>client</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>host</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;example.com&#34;</span> },
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=deno-compile><code>deno compile</code><a hidden class=anchor aria-hidden=true href=#deno-compile>#</a></h2><h3 id=byonmがサポート>BYONMがサポート<a hidden class=anchor aria-hidden=true href=#byonmがサポート>#</a></h3><p><a href=https://uki00a.github.io/deno-weekly/articles/deno/v1.38.html>Deno v1.38</a>で実装されたBYONMが<code>deno compile</code>コマンドでもサポートされました。これにより、Node.jsで実装されたCLIプログラムからスタンドアロンの実行可能ファイルを生成できる余地が生まれそうです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ npm i chalk@5.3.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat index.js
</span></span><span style=display:flex><span>import chalk from <span style=color:#e6db74>&#39;chalk&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>console.info<span style=color:#f92672>(</span>chalk.bold<span style=color:#f92672>(</span>chalk.green<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;foobar&#39;</span><span style=color:#f92672>)))</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ deno compile --unstable-byonm --output<span style=color:#f92672>=</span>sample index.js
</span></span><span style=display:flex><span>Compile file:///path/to/project/index.js to sample
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ./sample 
</span></span><span style=display:flex><span>foobar
</span></span></code></pre></div><h3 id=dynamic-importの挙動の改善>dynamic importの挙動の改善<a hidden class=anchor aria-hidden=true href=#dynamic-importの挙動の改善>#</a></h3><p><code>deno compile</code>で以下のように動的に<code>import()</code>の引数を作成しているケースがサポートされました。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>await</span> <span style=color:#66d9ef>import</span>(<span style=color:#e6db74>`./subdir/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>target</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span></code></pre></div><p>また、上記の場合、<code>./subdir</code>配下やその子孫のディレクトリからもモジュールを探して、それらも最終的なバイナリに含めることで、より安定して動作できるよう改善が図られているようです。</p><h2 id=web-api>Web API<a hidden class=anchor aria-hidden=true href=#web-api>#</a></h2><h3 id=readablestreambyobreaderreadでminオプションが実装><code>ReadableStreamBYOBReader#read</code>で<code>min</code>オプションが実装<a hidden class=anchor aria-hidden=true href=#readablestreambyobreaderreadでminオプションが実装>#</a></h3><p><a href=https://developer.mozilla.org/en-US/docs/Web/API/ReadableStreamBYOBReader/read>ReadableStreamBYOBReader#read</a>で<code>min</code>オプションがサポートされています。</p><p>このオプションを指定すると、<code>min</code>で指定された要素数が読み込まれるまでresolveされないように制御できるようです。</p><hr><blockquote><p><a href=https://github.com/whatwg/streams/pull/1145>Add ReadableStreamBYOBReader.prototype.read(view, { min }) (whatwg/streams#1145)</a></p></blockquote><h3 id=urlpatternのパフォーマンス改善>URLPatternのパフォーマンス改善<a hidden class=anchor aria-hidden=true href=#urlpatternのパフォーマンス改善>#</a></h3><p><a href=https://developer.mozilla.org/en-US/docs/Web/API/URLPattern>URLPattern</a>について、主にフレームワークなどのrouterとして使用されるケースを想定したパフォーマンス改善が実施されています。</p><blockquote><p><a href=https://github.com/denoland/deno/pull/21488>perf(ext/url): improve URLPattern perf #21488</a></p></blockquote><p>おそらくこの修正に合わせて、<a href=https://uki00a.github.io/deno-weekly/articles/2023/12/10.html>fresh v1.6.1</a>でも<code>RegExp</code>から<code>URLPattern</code>を使用してマッチングをするように修正されているようです。</p><h3 id=imagedataが実装><code>ImageData</code>が実装<a hidden class=anchor aria-hidden=true href=#imagedataが実装>#</a></h3><p><a href=https://developer.mozilla.org/en-US/docs/Web/API/ImageData><code>ImageData</code></a>がサポートされています。</p><h2 id=sloppy-importsのサポート---unstable-sloppy-imports>sloppy importsのサポート (<code>--unstable-sloppy-imports</code>)<a hidden class=anchor aria-hidden=true href=#sloppy-importsのサポート---unstable-sloppy-imports>#</a></h2><p><a href=https://uki00a.github.io/deno-weekly/articles/2023/12/10.html><code>--unstable-sloppy-imports</code></a>オプションが追加されました。</p><p>このオプションまたは<code>deno.json</code>で<code>unstable: ["sloppy-imports"]</code>を指定すると、以下のようなimportが有効化されます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// (1) 拡張子なしでのimport
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>add</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./add&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// (2) ディレクトリを指定したimport
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>foo</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./subdir&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// (3) `.ts`モジュールを`.js`拡張子でimport
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>sleep</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./subdir/sleep.js&#39;</span>;
</span></span></code></pre></div><p>この機能はNode.jsで書かれたプログラムをDenoで動かしやすくするために導入された機能のようで、Denoの一般的な使用においては指定することは推奨されないようです。実際に使用すると、以下のような警告が表示されます。</p><pre tabindex=0><code>Warning Sloppy imports are not recommended and have a negative impact on performance.
</code></pre><p>これに合わせて、<code>deno lsp</code>でも<code>sloppy-imports</code>向けのQuickfixがサポートされています。</p><h2 id=objectprototype__proto__の有効化---unstable-unsafe-proto><code>Object.prototype.__proto__</code>の有効化 (<code>--unstable-unsafe-proto</code>)<a hidden class=anchor aria-hidden=true href=#objectprototype__proto__の有効化---unstable-unsafe-proto>#</a></h2><p><a href=https://uki00a.github.io/deno-weekly/articles/2023/11/26.html><code>--unstable-unsafe-proto</code></a>オプションが実装されました。</p><p>セキュリティのためDenoはデフォルトで<code>Object.prototype.__proto__</code>を削除します。<code>deno.json</code>で<code>unstable: ["unsafe-proto"]</code>を設定するか、または<code>--unstable-unsafe-proto</code>オプションを指定することで、この挙動を無効化できます。</p><p>一部のnpmパッケージを動かすために<code>Object.prototype.__proto__</code>が欲しい場面での使用が想定されています。</p><h2 id=deno-lsp><code>deno lsp</code><a hidden class=anchor aria-hidden=true href=#deno-lsp>#</a></h2><h3 id=デバッグ向けのログ出力がサポート>デバッグ向けのログ出力がサポート<a hidden class=anchor aria-hidden=true href=#デバッグ向けのログ出力がサポート>#</a></h3><p>ワークスペースで<code>"deno.logFile": true</code>を指定しておくと、<code>.deno_lsp/log_{timestamp}.txt</code>にログを出力してくれます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// .vscode/settings.json
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;deno.logFile&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>"deno.internalDebug": true</code>と併用することで、より多くの情報が閲覧できるようです。</p><h2 id=deno-fmt><code>deno fmt</code><a hidden class=anchor aria-hidden=true href=#deno-fmt>#</a></h2><h3 id=ipynbがサポート><code>.ipynb</code>がサポート<a hidden class=anchor aria-hidden=true href=#ipynbがサポート>#</a></h3><p><a href=https://uki00a.github.io/deno-weekly/articles/deno/v1.37.html>Deno v1.37</a>での<code>deno jupyter</code>の実装に合わせて、<code>deno fmt</code>でも<code>.ipynb</code>ファイルをフォーマットできるようになりました。</p><h2 id=typescript-v53>TypeScript v5.3<a hidden class=anchor aria-hidden=true href=#typescript-v53>#</a></h2><p>Denoの内部に搭載されているTypeScriptが<a href=https://devblogs.microsoft.com/typescript/announcing-typescript-5-3/>v5.3</a>へアップデートされました。</p><h3 id=deno-v140での計画について>Deno v1.40での計画について<a hidden class=anchor aria-hidden=true href=#deno-v140での計画について>#</a></h3><p>Deno v1.39の時点では<code>experimentalDecorators</code>がデフォルトで有効化されています。</p><p><a href=https://deno.com/blog/v1.39>v1.39の公式ブログ</a>によると、Deno v1.40でこのデフォルトの挙動を変更し、<a href=https://github.com/tc39/proposal-decorators>TC39 decorators</a>の方をデフォルトで有効化することが検討されているようです。</p><p>そのため、もし<code>experimentalDecorators</code>を使っている場合は、今のうちに<code>deno.json</code>で<code>"compilerOptions.experimentalDecorators": true</code>を設定しておき、明示的に有効化しておくと安全なようです。</p><h2 id=nodejs互換性の改善>Node.js互換性の改善<a hidden class=anchor aria-hidden=true href=#nodejs互換性の改善>#</a></h2><p>今回のリリースでも様々な改善が実施されています。</p><h3 id=deno-taskでnode_modulesbinの探索がサポート><code>deno task</code>で<code>node_modules/.bin</code>の探索がサポート<a hidden class=anchor aria-hidden=true href=#deno-taskでnode_modulesbinの探索がサポート>#</a></h3><p><code>package.json</code>の<code>scripts</code>で定義されたスクリプトを<code>deno task</code>で実行する際に、<code>node_modules/.bin</code>に配置された実行可能ファイルを探索してくれるように改善されました。</p><h3 id=組み込みモジュールの改善>組み込みモジュールの改善<a hidden class=anchor aria-hidden=true href=#組み込みモジュールの改善>#</a></h3><ul><li><code>node:child_process</code>: <code>fork()</code>が実装されています。</li><li><code>node:util</code>: <code>parseArgs()</code>が実装されています。</li><li><code>node:vm</code>: <code>runInNewContext()</code>が実装されています。(<code>options</code>はまだサポートされていないようです)<ul><li>Webpack(+Next.js)の動作に向けた対応のようです (<a href=https://github.com/denoland/deno/pull/21527>#21527</a>)</li></ul></li><li><code>node:os</code>: <code>freemem()</code>の互換性の向上<ul><li>Linuxでは<a href="https://deno.land/api@v1.39.0?s=Deno.SystemMemoryInfo#prop_available">Deno.SystemMemoryInfo.available</a>、それ以外の環境では<a href="https://deno.land/api@v1.39.0?s=Deno.SystemMemoryInfo#prop_free">Deno.SystemMemoryInfo.free</a>と同じ値が返されるように挙動が変更されているようです。</li></ul></li><li><code>node:crypto</code>: <code>sign()</code>でPEM形式の秘密鍵がサポート</li><li><code>node:process</code>: <code>process.exitCode</code>の設定値がDenoによって認識されるように改善されています。</li></ul><h2 id=その他>その他<a hidden class=anchor aria-hidden=true href=#その他>#</a></h2><ul><li><code>Deno.ChildProcess</code>の型定義で<code>AsyncDisposable</code>ではなく<code>Disposable</code>が実装されていた問題が修正されています。</li><li><code>--allow-net=localhost:80</code>のようにホスト名と80番ポートを許可すると、対象ホストの全ポートへのアクセスが許可されてしまう問題が修正されています。</li><li><code>Deno.permissions.revoke</code>で<code>net</code>パーミッションを拒否しようとすると、プロセスがパニックする問題が修正されています。</li></ul><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li><a href=https://github.com/denoland/deno/releases/tag/v1.39.0>https://github.com/denoland/deno/releases/tag/v1.39.0</a></li><li><a href=https://deno.com/blog/v1.39>Deno 1.39: The Return of WebGPU</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://uki00a.github.io/deno-weekly/tags/deno.html>deno</a></li><li><a href=https://uki00a.github.io/deno-weekly/tags/deno-kv.html>Deno KV</a></li><li><a href=https://uki00a.github.io/deno-weekly/tags/deno-cron.html>Deno Cron</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://uki00a.github.io/deno-weekly/>週刊Deno</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>