<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Deno v2.1 | 週刊Deno</title><meta name=keywords content="Deno,OpenTelemetry"><meta name=description content="Deno v2.1がリリース。WASMモジュールのサポート, deno outdatedという新規コマンドが追加, deno taskでタスク間の依存関係を定義できるように, deno taskでDeno workspacesがサポート (--filterオプション), deno task --eval, deno init --npm (pnpm create相当のコマンド), deno compileでローカルファイル/ディレクトリの埋め込みがサポート, deno fmtでSQLのフォーマットが実験的にサポート, deno fmtとdeno lintで.gitignoreがサポート, DENO_TRACE_PERMISSIONS環境変数の導入, --env-fileで複数の.envファイルの読み込みがサポート, --allow-envで特定の名前で始まる環境変数を一括で許可できるように, Deno.telemetry (OpenTelemetryの実験的サポート), --unstable-detect-cjsの安定化, --unstable-node-globalsオプションの導入, fetch()のリクエストボディでのAsyncIterableサポートが再導入"><meta name=author content><link rel=canonical href=https://uki00a.github.io/deno-weekly/articles/deno/v2.1.html><link crossorigin=anonymous href=/deno-weekly/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/deno-weekly/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://raw.githubusercontent.com/uki00a/blog/master/src/assets/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://uki00a.github.io/deno-weekly/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://uki00a.github.io/deno-weekly/favicon-32x32.png><link rel=apple-touch-icon href=https://uki00a.github.io/deno-weekly/apple-touch-icon.png><link rel=mask-icon href=https://uki00a.github.io/deno-weekly/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:image" content="https://raw.githubusercontent.com/uki00a/blog/master/src/assets/avatar.png"><meta property="twitter:image" content="https://raw.githubusercontent.com/uki00a/blog/master/src/assets/avatar.png"><meta name=twitter:site content="@uki00a"><script async src="https://www.googletagmanager.com/gtag/js?id=G-MK2K2MRMBF"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-MK2K2MRMBF",{anonymize_ip:!1})}</script><meta property="og:title" content="Deno v2.1"><meta property="og:description" content="Deno v2.1がリリース。WASMモジュールのサポート, deno outdatedという新規コマンドが追加, deno taskでタスク間の依存関係を定義できるように, deno taskでDeno workspacesがサポート (--filterオプション), deno task --eval, deno init --npm (pnpm create相当のコマンド), deno compileでローカルファイル/ディレクトリの埋め込みがサポート, deno fmtでSQLのフォーマットが実験的にサポート, deno fmtとdeno lintで.gitignoreがサポート, DENO_TRACE_PERMISSIONS環境変数の導入, --env-fileで複数の.envファイルの読み込みがサポート, --allow-envで特定の名前で始まる環境変数を一括で許可できるように, Deno.telemetry (OpenTelemetryの実験的サポート), --unstable-detect-cjsの安定化, --unstable-node-globalsオプションの導入, fetch()のリクエストボディでのAsyncIterableサポートが再導入"><meta property="og:type" content="article"><meta property="og:url" content="https://uki00a.github.io/deno-weekly/articles/deno/v2.1.html"><meta property="article:section" content="articles"><meta property="article:published_time" content="2024-11-24T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-24T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deno v2.1"><meta name=twitter:description content="Deno v2.1がリリース。WASMモジュールのサポート, deno outdatedという新規コマンドが追加, deno taskでタスク間の依存関係を定義できるように, deno taskでDeno workspacesがサポート (--filterオプション), deno task --eval, deno init --npm (pnpm create相当のコマンド), deno compileでローカルファイル/ディレクトリの埋め込みがサポート, deno fmtでSQLのフォーマットが実験的にサポート, deno fmtとdeno lintで.gitignoreがサポート, DENO_TRACE_PERMISSIONS環境変数の導入, --env-fileで複数の.envファイルの読み込みがサポート, --allow-envで特定の名前で始まる環境変数を一括で許可できるように, Deno.telemetry (OpenTelemetryの実験的サポート), --unstable-detect-cjsの安定化, --unstable-node-globalsオプションの導入, fetch()のリクエストボディでのAsyncIterableサポートが再導入"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Deno v2.1","item":"https://uki00a.github.io/deno-weekly/articles/deno/v2.1.html"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Deno v2.1","name":"Deno v2.1","description":"Deno v2.1がリリース。WASMモジュールのサポート, deno outdatedという新規コマンドが追加, deno taskでタスク間の依存関係を定義できるように, deno taskでDeno workspacesがサポート (--filterオプション), deno task --eval, deno init --npm (pnpm create相当のコマンド), deno compileでローカルファイル/ディレクトリの埋め込みがサポート, deno fmtでSQLのフォーマットが実験的にサポート, deno fmtとdeno lintで.gitignoreがサポート, DENO_TRACE_PERMISSIONS環境変数の導入, --env-fileで複数の.envファイルの読み込みがサポート, --allow-envで特定の名前で始まる環境変数を一括で許可できるように, Deno.telemetry (OpenTelemetryの実験的サポート), --unstable-detect-cjsの安定化, --unstable-node-globalsオプションの導入, fetch()のリクエストボディでのAsyncIterableサポートが再導入","keywords":["Deno","OpenTelemetry"],"articleBody":"Deno v2.1がリリースされました。\nこの記事では主な変更点などについて解説します。\n.wasmファイルのimportがサポート .wasmファイルのimportがサポートされました。\n通常のJavaScriptモジュールと同様に、リモートの.wasmファイルをimportすることもできます:\nimport { add } from \"https://raw.githubusercontent.com/denoland/deno/refs/tags/v2.1.0/tests/testdata/wasm/math.wasm\";  console.info(add(1, 2)); また、deno docコマンドでも.wasmファイルがサポートされています:\n$ deno doc https://raw.githubusercontent.com/dyedgreen/deno-sqlite/refs/tags/v3.9.1/build/sqlite.wasm Defined in https://raw.githubusercontent.com/dyedgreen/deno-sqlite/refs/tags/v3.9.1/build/sqlite.wasm:45:1  function argument_blob(arg0: number): number   ...  function total_changes(): number  Defined in https://raw.githubusercontent.com/dyedgreen/deno-sqlite/refs/tags/v3.9.1/build/sqlite.wasm:2:22  const memory: WebAssembly.Memory deno outdated deno outdatedという新しいコマンドが実装されています。\n引数なしで実行すると、各依存関係の最新バージョンが表示されます:\n$ deno outdated ┌────────────────────┬─────────┬────────┬────────┐ │ Package │ Current │ Update │ Latest │ ├────────────────────┼─────────┼────────┼────────┤ │ jsr:@oak/oak │ 17.1.0 │ 17.1.3 │ 17.1.3 │ ├────────────────────┼─────────┼────────┼────────┤ │ jsr:@hono/hono │ 4.6.4 │ 4.6.11 │ 4.6.11 │ ├────────────────────┼─────────┼────────┼────────┤ │ npm:@nestjs/common │ 10.4.4 │ 10.4.8 │ 10.4.8 │ ├────────────────────┼─────────┼────────┼────────┤ │ npm:@nestjs/core │ 10.4.4 │ 10.4.8 │ 10.4.8 │ └────────────────────┴─────────┴────────┴────────┘ 引数を指定することで、指定したパターンにマッチするパッケージの情報のみを表示できます:\n$ deno outdated \"@nestjs/*\" ┌────────────────────┬─────────┬────────┬────────┐ │ Package │ Current │ Update │ Latest │ ├────────────────────┼─────────┼────────┼────────┤ │ npm:@nestjs/common │ 10.4.4 │ 10.4.8 │ 10.4.8 │ ├────────────────────┼─────────┼────────┼────────┤ │ npm:@nestjs/core │ 10.4.4 │ 10.4.8 │ 10.4.8 │ └────────────────────┴─────────┴────────┴────────┘ --compatibleを指定すると、deno.jsonで宣言されたバージョンレンジに基づいて、アップデート可能なパッケージのみが表示されます:\n$ deno outdated --compatible --updateオプションを指定することで、依存関係をアップデートできます:\n# deno.jsonで指定されたバージョンレンジに基づいて指定されたパッケージを更新する $ deno outdated --update \"@nestjs/*\"  # バージョンを明示する $ deno outdated --update @nestjs/common@^10.4.8 @nestjs/core@^10.4.8 --latestオプションを指定すると、deno.jsonで指定されたバージョンレンジに関わらず、常に最新バージョンへアップデートしてくれるようです:\n$ deno outdated --update --latest \"@nestjs/*\" また、ワークスペースの各メンバーの依存もアップデートしたい場合、--recursiveオプションを指定します:\n$ deno outdated --recursive --update deno task タスク間の依存関係の定義がサポート 各タスク間の依存関係の定義がサポートされています。\nこの機能の導入に伴い、オブジェクト形式でのタスクの定義がサポートされています。現状ではcommand, description, dependenciesの3つのプロパティーを指定できます。\nタスク間の依存関係を定義したい場合、dependenciesプロパティーを指定する必要があります:\n{  \"tasks\": {  \"check:all\": {  \"command\": \"echo 'All checks have been passed!'\",  \"description\": \"Run all checks\",  \"dependencies\": [\"check:fmt\", \"check:deno-json\"]  },  \"check:fmt\": \"deno fmt --check\",  \"check:deno-json\": {  \"description\": \"Check if deno.json is valid\",  \"command\": \"deno run --allow-read=deno.json tools/check_deno_json.js\"  }  } } 上記の場合にdeno task check:allを実行すると、まずcheck:fmtとcheck:deno-jsonタスクが並列で実行され、それらが成功した場合のみcheck:allのcommandが実行されます。\n引数なしでdeno taskを実行すると、descriptionプロパティーに記載された内容がコメントとして表示されます (これに伴い、引数なしのdeno taskコマンドがdeno.jsoncにおいて各タスクに記述されたコメントを認識してくれる機能が削除されています)\n $ deno task Available tasks: - check:all  // Run all checks  echo OK  depends on: check:fmt, check:deno-json - check:fmt  deno fmt --check - check:deno-json  // Check if deno.json is valid  deno run --allow-read=deno.json tools/check _deno_json.js Deno workspacesのサポート deno taskコマンドに--filterオプションが追加されています。このオプションが指定されると、ワークスペース内において、名前がこのオプションで指定されたパターンにマッチするパッケージで定義されたタスクを実行できるようです:\n# 名前が`platform-*`パターンにマッチするメンバーのhiタスクを実行 $ deno task --filter 'platform-*' hi  # すべてのメンバーのhiタスクを実行 $ deno task --filter '*' hi --evalオプションが追加 指定された引数をDenoに組み込まれたdeno_task_shellを使って評価してくれます:\n$ deno task --eval 'cat deno.json | jq .imports' Task cat deno.json | jq .imports {  \"@nestjs/common\": \"npm:@nestjs/common@^10\",  \"@nestjs/core\": \"npm:@nestjs/core@^10\",  \"@oak/oak\": \"jsr:@oak/oak@^17\",  \"@hono/hono\": \"jsr:@hono/hono@^4\" } deno init --npmオプションのサポート deno init --npm のように実行すると、npmレジストリからnpm:create-がダウンロードされ、実行されます。\n例えば、以下のコマンドを実行するとcreate-honoパッケージが実行されます:\n$ deno init --npm hono ⚠️ Do you fully trust npm:create-hono package? Deno will invoke code from it with all permissions. Do you want to continue? [y/n]  deno compile 実行可能ファイルへのローカルのファイル/ディレクトリの埋め込みがサポート (--include) ローカルに存在する任意のファイルやディレクトリの実行可能ファイルへの埋め込みがサポートされています:\n// main.js console.info(await Deno.readTextFile(import.meta.dirname + \"/data/test.txt\")); deno compileに--includeオプションを指定することで、ファイルまたはディレクトリを埋め込むことができます:\n$ cat data/test.txt foo bar  $ deno compile --output sample --include ./data ./main.js  $ ./sample foo bar V8コードキャッシュのサポート deno compileで生成される実行可能ファイルにおいてもV8コードキャッシュがサポートされました (この機能はデフォルトで有効化されており、--no-code-cacheで無効化できます)\n生成された実行可能ファイルの初回実行時に/tmpにV8コードキャッシュが保存されます。2回目以降の実行時に/tmpに保存されたV8コードキャッシュが読み込まれます。\nV8コードキャッシュの保存先について 以下のPRにおいて、V8コードキャッシュの保存先のパスを表示してくれる変更が導入されています:\n chore(compile): log code cache file path (#26977)  今後、この変更が導入されれば、以下のようにしてV8コードキャッシュの保存先を確認できるようになりそうです:\n$ DENO_LOG=debug ./sample deno fmt SQLのフォーマットがサポート Deno v1.46で導入されたdeno fmtでのYAMLやCSSなどのサポートに続いて、Deno v2.1では.sqlファイルのフォーマットが実験的にサポートされています。\ndeno.jsonで\"unstable\": [\"fmt-sql\"]を指定する または deno fmtに--unstable-sqlを指定することで、.sqlファイルのフォーマットが有効化されます。\n.gitignoreのサポート deno fmtコマンドが.gitignoreの内容を参照して、フォーマット対象から除外すべきファイルを判断するよう改善されています。\ndeno lint .gitignoreのサポート deno fmtコマンドと同様に、deno lintコマンドでも.gitignoreの内容を元にチェック対象から除外すべきファイルを判断するよう改善されています。\ndeno lint --json - checked_filesフィールドの追加 エラーが発生したファイルの一覧が格納されるようです:\n$ deno lint --json | jq .checked_files [  \"/home/uki00a/ghq/github.com/uki00a/deno-sandbox/main.js\" ] deno lsp Auto importsでの// @deno-typesディレクティブのサポート 自前で型定義を提供しないnpmパッケージなどに対して、// @deno-types付きでimport文を挿入できるようにする機能が実装されています。\ndeno.jsonが存在する場合、エディタ向けに定義されたフォーマットに関する設定が無視されるように インデントなどに関する設定が.vscode/settings.jsonなどの設定ファイルで定義されていると、deno.jsonで定義されたインデントなどの設定が無視されてしまう問題が修正されています。\ndeno publish --set-versionオプションの追加 このオプションが指定された場合、パッケージがdeno.jsonで指定されたバージョンではなくこのオプションで指定されたバージョンとして公開されます。\ndeno info Web Cache APIのキャッシュ先の表示がサポート deno infoコマンドがWeb Cache APIのキャッシュ先として利用されるディレクトリを表示してくれるよう改善されています。\ndeno test ドキュメント内のコードブロックの実行(--doc)時にコメントが保持されない問題の修正 deno test --docでMarkdownやJSDocコメント内のコードブロックを実行する際に、コメントが削除されてしまい、// @ts-expect-errorなどが動作しない問題が修正されています。\nCLI DENO_TRACE_PERMISSIONS環境変数の導入 DENO_TRACE_PERMISSIONSという環境変数が導入されています。この環境変数を設定すると、パーミッションプロンプトにおいてスタックトレースの表示が有効化され、あるパーミッションがどこで要求されたか判断しやすくなります:\n$ DENO_TRACE_PERMISSIONS=1 deno run main.js ┏ ⚠️ Deno requests read access to \"/home/uki00a/ghq/github.com/uki00a/deno-sandbox/data/test.txt\". ┠─ Requested by `Deno.readFile()` API. ┃ ├─ op_fs_read_file_text_async (ext:core/00_infra.js:260:33) ┃ ├─ Object.readTextFile (ext:deno_fs/30_fs.js:779:24) ┃ └─ file:///home/uki00a/ghq/github.com/uki00a/deno-sandbox/main.js:1:25 ┠─ Learn more at: https://docs.deno.com/go/--allow-read ┠─ Run again with --allow-read to bypass this prompt. ┗ Allow? [y/n/A] (y = yes, allow; n = no, deny; A = allow all read permissions)  スタックトレースの収集は高価な処理のため、この機能は本番環境などにおいては無効化することがDenoの公式ブログでは推奨されています。\n--env-fileで複数の.envファイルの読み込みがサポート --env-fileオプションを複数回指定することで、複数の.envファイルの読み込みがサポートされています。\n--allow-env - 特定の名前で始まる環境変数の参照がサポート --allow-envに末尾が*で終わるパターンを指定した際に、該当のパターンに前方一致する環境変数への参照をまとめて許可することができます:\n# 名前が`APP_`から始まる環境変数の参照を許可します $ deno run --allow-env='APP_*' main.js deno.lock compilerOptionsで指定された依存関係のサポート deno.lockがdeno.jsonのcompilerOptions.jsxImportSourceやcompilerOptions.jsxImportSourceTypesなどで指定されたパッケージも追跡してくれるよう改善されています。\nDeno API Deno.telemetry (OpenTelemetryのサポート) Deno.telemetryという実験的APIが追加されています。--unstable-otelまたはdeno.jsonで\"unstable\": [\"otel\"]を指定することで有効化できます。\nこのDeno.telemetryとopentelemetry-jsを連携させるための@deno/otelというJSRパッケージが公開されています。\nDeno.jupyter.image Deno.jupyter.imageというAPIが追加されています。.jpgまたは.pngファイルをパスもしくはUint8Arrayで指定することで、Jupyter Notebook上に指定された画像を表示できるようです。\nDeno.FileInfo.ctime Deno.statなどで返却されるDeno.FileInfoにctimeが追加されています。\nDeno.serve ブラウザーからAccept-Encoding: gzip, deflate, br, zstdが指定された場合、Brotliが使用されるよう挙動が改善されています。\nNode.js互換性の改善 --unstable-detect-cjsの安定化 --unstable-detect-cjsが指定されたときのみ有効化されていた、package.jsonで\"type\": \"commonjs\"が定義されているパッケージで.jsファイルをCommon JSモジュールとして読み込めるようにする機能がデフォルトで有効化されました。\n--unstable-node-globalsオプションが追加 このオプションを指定することで、Node.jsの各種グローバルAPIを有効化することができます。例えば、以下のようにNode.jsのグローバルAPIに依存したスクリプトがあったとします:\nconsole.info(setImmediate); この場合、--unstable-node-globalsオプションを指定することで、DenoでもNode.jsのグローバルAPIが参照されたスクリプトを実行することができます:\n# `--unstable-node-globals`なしだとエラーが発生します $ deno run main.js error: Uncaught (in promise) ReferenceError: setImmediate is not defined console.info(setImmediate);  ^  at file:///home/uki00a/ghq/github.com/uki00a/deno-sandbox/main.js:1:14   info: setImmediate is not available in the global scope in Deno.  hint: Import it explicitly with import { setImmediate } from \"node:timers\";,  or run again with --unstable-node-globals flag to add this global.  # `--unstable-node-globals`を指定すると、実行に成功します $ deno run --unstable-node-globals main.js [Function: setImmediate] node:perf_hooks monitorEventLoopDelay()が実装されました。\nnode:timers/promises setInterval()が再実装され、互換性が改善されています。\nnode:net createConnection()でautoSelectFamilyオプションがサポートされています。\nnode:module getBuiltinModule()が実装されています。\nnode:zlib crc32()が実装されています。\nnode:crypto generateKeyPair()でpromisify() (node:util)が動作するよう改善されています。\n.//の取り扱いの変更 Node.jsと同様に、.//という形式のパスを./として取り扱うよう挙動が修正されています。\ndeno install pnpmに合わせて、ライフサイクルスクリプトが実行されたnpmパッケージに対して、再度binエントリがセットアップされるよう挙動が修正されています。Supabase CLIなどが動作しない問題への対策のようです。\n  Installing a npm package with a bin populated by a postinstall script doesn’t work (#26677)  Web API fetch()のリクエストボディでのAsyncIterableのサポート fetch()のリクエストボディに対するAsyncIterableのサポートが再導入されています (この機能はDeno v1.46.0で一度導入され、Deno v1.46.2にてrevertされていました)\nimport { createReadStream } from \"node:fs\";  const stream = createReadStream(\"./data.txt\"); const res = await fetch(\"http://localhost:8000/upload\", {  method: \"POST\",  body: stream }); パフォーマンス改善 Windowsでの起動の高速化 いくつかのDLLファイルを遅延読み込みさせることで、Windowsにおける起動速度が改善されているようです。\n  perf(windows): delay load webgpu and some other dlls (#26917)  Out of Memoryエラーへの対策 Out of Memoryエラーへの対策として、V8のデフォルトのヒープ長がシステムで利用可能なメモリに応じて調整されるよう改善されています。\nV8 13.0 Denoに組み込まれたV8のバージョンが13.0へアップデートされています。\n参考  Deno 2.1: Wasm Imports and other enhancements https://github.com/denoland/deno/releases/tag/v2.1.0  ","wordCount":"713","inLanguage":"en","datePublished":"2024-11-24T00:00:00Z","dateModified":"2024-11-24T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://uki00a.github.io/deno-weekly/articles/deno/v2.1.html"},"publisher":{"@type":"Organization","name":"週刊Deno","logo":{"@type":"ImageObject","url":"https://raw.githubusercontent.com/uki00a/blog/master/src/assets/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://uki00a.github.io/deno-weekly/ accesskey=h title="週刊Deno (Alt + H)">週刊Deno</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://uki00a.github.io/deno-weekly/tags.html title=タグ><span><i class="fa fa-heart"></i>タグ</span></a></li><li><a href=https://uki00a.github.io/deno-weekly/categories.html title=カテゴリー><span><i class="fa fa-heart"></i>カテゴリー</span></a></li><li><a href=https://uki00a.github.io/deno-weekly/gallery.html title=ギャラリー><span><i class="fa fa-road"></i>ギャラリー<span class=alert></span></span></a></li><li><a href=https://uki00a.github.io/deno-weekly/index.xml title="RSS feed"><span><i class="fa fa-road"></i>RSS feed<span class=alert></span></span></a></li><li><a href=https://uki00a.github.io/deno-weekly/about.html title=About><span><i class="fa fa-road"></i>About<span class=alert></span></span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Deno v2.1</h1><div class=post-description>Deno v2.1がリリース。WASMモジュールのサポート, deno outdatedという新規コマンドが追加, deno taskでタスク間の依存関係を定義できるように, deno taskでDeno workspacesがサポート (--filterオプション), deno task --eval, deno init --npm (pnpm create相当のコマンド), deno compileでローカルファイル/ディレクトリの埋め込みがサポート, deno fmtでSQLのフォーマットが実験的にサポート, deno fmtとdeno lintで.gitignoreがサポート, DENO_TRACE_PERMISSIONS環境変数の導入, --env-fileで複数の.envファイルの読み込みがサポート, --allow-envで特定の名前で始まる環境変数を一括で許可できるように, Deno.telemetry (OpenTelemetryの実験的サポート), --unstable-detect-cjsの安定化, --unstable-node-globalsオプションの導入, fetch()のリクエストボディでのAsyncIterableサポートが再導入</div><div class=post-meta><span title="2024-11-24 00:00:00 +0000 UTC">November 24, 2024</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#wasm%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%aeimport%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=.wasmファイルのimportがサポート><code>.wasm</code>ファイルの<code>import</code>がサポート</a></li><li><a href=#deno-outdated aria-label="deno outdated"><code>deno outdated</code></a></li><li><a href=#deno-task aria-label="deno task"><code>deno task</code></a><ul><li><a href=#%e3%82%bf%e3%82%b9%e3%82%af%e9%96%93%e3%81%ae%e4%be%9d%e5%ad%98%e9%96%a2%e4%bf%82%e3%81%ae%e5%ae%9a%e7%be%a9%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=タスク間の依存関係の定義がサポート>タスク間の依存関係の定義がサポート</a></li><li><a href=#deno-workspaces%e3%81%ae%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label="Deno workspacesのサポート">Deno workspacesのサポート</a></li><li><a href=#--eval%e3%82%aa%e3%83%97%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%8c%e8%bf%bd%e5%8a%a0 aria-label=--evalオプションが追加><code>--eval</code>オプションが追加</a></li></ul></li><li><a href=#deno-init aria-label="deno init"><code>deno init</code></a><ul><li><a href=#--npm%e3%82%aa%e3%83%97%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%ae%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=--npmオプションのサポート><code>--npm</code>オプションのサポート</a></li></ul></li><li><a href=#deno-compile aria-label="deno compile"><code>deno compile</code></a><ul><li><a href=#%e5%ae%9f%e8%a1%8c%e5%8f%af%e8%83%bd%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%b8%e3%81%ae%e3%83%ad%e3%83%bc%e3%82%ab%e3%83%ab%e3%81%ae%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%83%87%e3%82%a3%e3%83%ac%e3%82%af%e3%83%88%e3%83%aa%e3%81%ae%e5%9f%8b%e3%82%81%e8%be%bc%e3%81%bf%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88---include aria-label="実行可能ファイルへのローカルのファイル/ディレクトリの埋め込みがサポート (--include)">実行可能ファイルへのローカルのファイル/ディレクトリの埋め込みがサポート (<code>--include</code>)</a></li><li><a href=#v8%e3%82%b3%e3%83%bc%e3%83%89%e3%82%ad%e3%83%a3%e3%83%83%e3%82%b7%e3%83%a5%e3%81%ae%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=V8コードキャッシュのサポート>V8コードキャッシュのサポート</a><ul><li><a href=#v8%e3%82%b3%e3%83%bc%e3%83%89%e3%82%ad%e3%83%a3%e3%83%83%e3%82%b7%e3%83%a5%e3%81%ae%e4%bf%9d%e5%ad%98%e5%85%88%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6 aria-label=V8コードキャッシュの保存先について>V8コードキャッシュの保存先について</a></li></ul></li></ul></li><li><a href=#deno-fmt aria-label="deno fmt"><code>deno fmt</code></a><ul><li><a href=#sql%e3%81%ae%e3%83%95%e3%82%a9%e3%83%bc%e3%83%9e%e3%83%83%e3%83%88%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=SQLのフォーマットがサポート>SQLのフォーマットがサポート</a></li><li><a href=#gitignore%e3%81%ae%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=.gitignoreのサポート><code>.gitignore</code>のサポート</a></li></ul></li><li><a href=#deno-lint aria-label="deno lint"><code>deno lint</code></a><ul><li><a href=#gitignore%e3%81%ae%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88-1 aria-label=.gitignoreのサポート><code>.gitignore</code>のサポート</a></li><li><a href=#deno-lint---json---checked_files%e3%83%95%e3%82%a3%e3%83%bc%e3%83%ab%e3%83%89%e3%81%ae%e8%bf%bd%e5%8a%a0 aria-label="deno lint --json - checked_filesフィールドの追加"><code>deno lint --json</code> - <code>checked_files</code>フィールドの追加</a></li></ul></li><li><a href=#deno-lsp aria-label="deno lsp"><code>deno lsp</code></a><ul><li><a href=#auto-imports%e3%81%a7%e3%81%ae-deno-types%e3%83%87%e3%82%a3%e3%83%ac%e3%82%af%e3%83%86%e3%82%a3%e3%83%96%e3%81%ae%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label="Auto importsでの// @deno-typesディレクティブのサポート">Auto importsでの<code>// @deno-types</code>ディレクティブのサポート</a></li><li><a href=#denojson%e3%81%8c%e5%ad%98%e5%9c%a8%e3%81%99%e3%82%8b%e5%a0%b4%e5%90%88%e3%82%a8%e3%83%87%e3%82%a3%e3%82%bf%e5%90%91%e3%81%91%e3%81%ab%e5%ae%9a%e7%be%a9%e3%81%95%e3%82%8c%e3%81%9f%e3%83%95%e3%82%a9%e3%83%bc%e3%83%9e%e3%83%83%e3%83%88%e3%81%ab%e9%96%a2%e3%81%99%e3%82%8b%e8%a8%ad%e5%ae%9a%e3%81%8c%e7%84%a1%e8%a6%96%e3%81%95%e3%82%8c%e3%82%8b%e3%82%88%e3%81%86%e3%81%ab aria-label=deno.jsonが存在する場合、エディタ向けに定義されたフォーマットに関する設定が無視されるように><code>deno.json</code>が存在する場合、エディタ向けに定義されたフォーマットに関する設定が無視されるように</a></li></ul></li><li><a href=#deno-publish aria-label="deno publish"><code>deno publish</code></a><ul><li><a href=#--set-version%e3%82%aa%e3%83%97%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%ae%e8%bf%bd%e5%8a%a0 aria-label=--set-versionオプションの追加><code>--set-version</code>オプションの追加</a></li></ul></li><li><a href=#deno-info aria-label="deno info"><code>deno info</code></a><ul><li><a href=#web-cache-api%e3%81%ae%e3%82%ad%e3%83%a3%e3%83%83%e3%82%b7%e3%83%a5%e5%85%88%e3%81%ae%e8%a1%a8%e7%a4%ba%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label="Web Cache APIのキャッシュ先の表示がサポート">Web Cache APIのキャッシュ先の表示がサポート</a></li></ul></li><li><a href=#deno-test aria-label="deno test"><code>deno test</code></a><ul><li><a href=#%e3%83%89%e3%82%ad%e3%83%a5%e3%83%a1%e3%83%b3%e3%83%88%e5%86%85%e3%81%ae%e3%82%b3%e3%83%bc%e3%83%89%e3%83%96%e3%83%ad%e3%83%83%e3%82%af%e3%81%ae%e5%ae%9f%e8%a1%8c--doc%e6%99%82%e3%81%ab%e3%82%b3%e3%83%a1%e3%83%b3%e3%83%88%e3%81%8c%e4%bf%9d%e6%8c%81%e3%81%95%e3%82%8c%e3%81%aa%e3%81%84%e5%95%8f%e9%a1%8c%e3%81%ae%e4%bf%ae%e6%ad%a3 aria-label=ドキュメント内のコードブロックの実行(--doc)時にコメントが保持されない問題の修正>ドキュメント内のコードブロックの実行(<code>--doc</code>)時にコメントが保持されない問題の修正</a></li></ul></li><li><a href=#cli aria-label=CLI>CLI</a><ul><li><a href=#deno_trace_permissions%e7%92%b0%e5%a2%83%e5%a4%89%e6%95%b0%e3%81%ae%e5%b0%8e%e5%85%a5 aria-label=DENO_TRACE_PERMISSIONS環境変数の導入><code>DENO_TRACE_PERMISSIONS</code>環境変数の導入</a></li><li><a href=#--env-file%e3%81%a7%e8%a4%87%e6%95%b0%e3%81%aeenv%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%ae%e8%aa%ad%e3%81%bf%e8%be%bc%e3%81%bf%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=--env-fileで複数の.envファイルの読み込みがサポート><code>--env-file</code>で複数の<code>.env</code>ファイルの読み込みがサポート</a></li><li><a href=#--allow-env---%e7%89%b9%e5%ae%9a%e3%81%ae%e5%90%8d%e5%89%8d%e3%81%a7%e5%a7%8b%e3%81%be%e3%82%8b%e7%92%b0%e5%a2%83%e5%a4%89%e6%95%b0%e3%81%ae%e5%8f%82%e7%85%a7%e3%81%8c%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label="--allow-env - 特定の名前で始まる環境変数の参照がサポート"><code>--allow-env</code> - 特定の名前で始まる環境変数の参照がサポート</a></li></ul></li><li><a href=#denolock aria-label=deno.lock><code>deno.lock</code></a><ul><li><a href=#compileroptions%e3%81%a7%e6%8c%87%e5%ae%9a%e3%81%95%e3%82%8c%e3%81%9f%e4%be%9d%e5%ad%98%e9%96%a2%e4%bf%82%e3%81%ae%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=compilerOptionsで指定された依存関係のサポート><code>compilerOptions</code>で指定された依存関係のサポート</a></li></ul></li><li><a href=#deno-api aria-label="Deno API">Deno API</a><ul><li><a href=#denotelemetry-opentelemetry%e3%81%ae%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label="Deno.telemetry (OpenTelemetryのサポート)"><code>Deno.telemetry</code> (OpenTelemetryのサポート)</a></li><li><a href=#denojupyterimage aria-label=Deno.jupyter.image><code>Deno.jupyter.image</code></a></li><li><a href=#denofileinfoctime aria-label=Deno.FileInfo.ctime><code>Deno.FileInfo.ctime</code></a></li><li><a href=#denoserve aria-label=Deno.serve><code>Deno.serve</code></a></li></ul></li><li><a href=#nodejs%e4%ba%92%e6%8f%9b%e6%80%a7%e3%81%ae%e6%94%b9%e5%96%84 aria-label=Node.js互換性の改善>Node.js互換性の改善</a><ul><li><a href=#--unstable-detect-cjs%e3%81%ae%e5%ae%89%e5%ae%9a%e5%8c%96 aria-label=--unstable-detect-cjsの安定化><code>--unstable-detect-cjs</code>の安定化</a></li><li><a href=#--unstable-node-globals%e3%82%aa%e3%83%97%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%8c%e8%bf%bd%e5%8a%a0 aria-label=--unstable-node-globalsオプションが追加><code>--unstable-node-globals</code>オプションが追加</a></li><li><a href=#nodeperf_hooks aria-label=node:perf_hooks><code>node:perf_hooks</code></a></li><li><a href=#nodetimerspromises aria-label=node:timers/promises><code>node:timers/promises</code></a></li><li><a href=#nodenet aria-label=node:net><code>node:net</code></a></li><li><a href=#nodemodule aria-label=node:module><code>node:module</code></a></li><li><a href=#nodezlib aria-label=node:zlib><code>node:zlib</code></a></li><li><a href=#nodecrypto aria-label=node:crypto><code>node:crypto</code></a></li><li><a href=#filename%e3%81%ae%e5%8f%96%e3%82%8a%e6%89%b1%e3%81%84%e3%81%ae%e5%a4%89%e6%9b%b4 aria-label=.//&amp;lt;filename&amp;gt;の取り扱いの変更><code>.//&lt;filename></code>の取り扱いの変更</a></li><li><a href=#deno-install aria-label="deno install"><code>deno install</code></a></li></ul></li><li><a href=#web-api aria-label="Web API">Web API</a><ul><li><a href=#fetch%e3%81%ae%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e3%83%9c%e3%83%87%e3%82%a3%e3%81%a7%e3%81%aeasynciterableuint8array%e3%81%ae%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88 aria-label=fetch()のリクエストボディでのAsyncIterable&amp;lt;Uint8Array&amp;gt;のサポート><code>fetch()</code>のリクエストボディでの<code>AsyncIterable&lt;Uint8Array></code>のサポート</a></li></ul></li><li><a href=#%e3%83%91%e3%83%95%e3%82%a9%e3%83%bc%e3%83%9e%e3%83%b3%e3%82%b9%e6%94%b9%e5%96%84 aria-label=パフォーマンス改善>パフォーマンス改善</a><ul><li><a href=#windows%e3%81%a7%e3%81%ae%e8%b5%b7%e5%8b%95%e3%81%ae%e9%ab%98%e9%80%9f%e5%8c%96 aria-label=Windowsでの起動の高速化>Windowsでの起動の高速化</a></li><li><a href=#out-of-memory%e3%82%a8%e3%83%a9%e3%83%bc%e3%81%b8%e3%81%ae%e5%af%be%e7%ad%96 aria-label="Out of Memoryエラーへの対策">Out of Memoryエラーへの対策</a></li></ul></li><li><a href=#v8-130 aria-label="V8 13.0">V8 13.0</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div><div class=post-content><p>Deno v2.1がリリースされました。</p><p>この記事では主な変更点などについて解説します。</p><h2 id=wasmファイルのimportがサポート><code>.wasm</code>ファイルの<code>import</code>がサポート<a hidden class=anchor aria-hidden=true href=#wasmファイルのimportがサポート>#</a></h2><p><code>.wasm</code>ファイルの<code>import</code>がサポートされました。</p><p>通常のJavaScriptモジュールと同様に、リモートの<code>.wasm</code>ファイルを<code>import</code>することもできます:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>add</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;https://raw.githubusercontent.com/denoland/deno/refs/tags/v2.1.0/tests/testdata/wasm/math.wasm&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>info</span>(<span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>));
</span></span></code></pre></div><p>また、<code>deno doc</code>コマンドでも<code>.wasm</code>ファイルがサポートされています:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ deno doc https://raw.githubusercontent.com/dyedgreen/deno-sqlite/refs/tags/v3.9.1/build/sqlite.wasm
</span></span><span style=display:flex><span>Defined in https://raw.githubusercontent.com/dyedgreen/deno-sqlite/refs/tags/v3.9.1/build/sqlite.wasm:45:1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> argument_blob<span style=color:#f92672>(</span>arg0: number<span style=color:#f92672>)</span>: number
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> total_changes<span style=color:#f92672>()</span>: number
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Defined in https://raw.githubusercontent.com/dyedgreen/deno-sqlite/refs/tags/v3.9.1/build/sqlite.wasm:2:22
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>const memory: WebAssembly.Memory
</span></span></code></pre></div><h2 id=deno-outdated><code>deno outdated</code><a hidden class=anchor aria-hidden=true href=#deno-outdated>#</a></h2><p><code>deno outdated</code>という新しいコマンドが実装されています。</p><p>引数なしで実行すると、各依存関係の最新バージョンが表示されます:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ deno outdated
</span></span><span style=display:flex><span>┌────────────────────┬─────────┬────────┬────────┐
</span></span><span style=display:flex><span>│ Package            │ Current │ Update │ Latest │
</span></span><span style=display:flex><span>├────────────────────┼─────────┼────────┼────────┤
</span></span><span style=display:flex><span>│ jsr:@oak/oak       │ 17.1.0  │ 17.1.3 │ 17.1.3 │
</span></span><span style=display:flex><span>├────────────────────┼─────────┼────────┼────────┤
</span></span><span style=display:flex><span>│ jsr:@hono/hono     │ 4.6.4   │ 4.6.11 │ 4.6.11 │
</span></span><span style=display:flex><span>├────────────────────┼─────────┼────────┼────────┤
</span></span><span style=display:flex><span>│ npm:@nestjs/common │ 10.4.4  │ 10.4.8 │ 10.4.8 │
</span></span><span style=display:flex><span>├────────────────────┼─────────┼────────┼────────┤
</span></span><span style=display:flex><span>│ npm:@nestjs/core   │ 10.4.4  │ 10.4.8 │ 10.4.8 │
</span></span><span style=display:flex><span>└────────────────────┴─────────┴────────┴────────┘
</span></span></code></pre></div><p>引数を指定することで、指定したパターンにマッチするパッケージの情報のみを表示できます:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ deno outdated <span style=color:#e6db74>&#34;@nestjs/*&#34;</span>
</span></span><span style=display:flex><span>┌────────────────────┬─────────┬────────┬────────┐
</span></span><span style=display:flex><span>│ Package            │ Current │ Update │ Latest │
</span></span><span style=display:flex><span>├────────────────────┼─────────┼────────┼────────┤
</span></span><span style=display:flex><span>│ npm:@nestjs/common │ 10.4.4  │ 10.4.8 │ 10.4.8 │
</span></span><span style=display:flex><span>├────────────────────┼─────────┼────────┼────────┤
</span></span><span style=display:flex><span>│ npm:@nestjs/core   │ 10.4.4  │ 10.4.8 │ 10.4.8 │
</span></span><span style=display:flex><span>└────────────────────┴─────────┴────────┴────────┘
</span></span></code></pre></div><p><code>--compatible</code>を指定すると、<code>deno.json</code>で宣言されたバージョンレンジに基づいて、アップデート可能なパッケージのみが表示されます:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ deno outdated --compatible
</span></span></code></pre></div><p><code>--update</code>オプションを指定することで、依存関係をアップデートできます:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># deno.jsonで指定されたバージョンレンジに基づいて指定されたパッケージを更新する</span>
</span></span><span style=display:flex><span>$ deno outdated --update <span style=color:#e6db74>&#34;@nestjs/*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># バージョンを明示する</span>
</span></span><span style=display:flex><span>$ deno outdated --update @nestjs/common@^10.4.8 @nestjs/core@^10.4.8
</span></span></code></pre></div><p><code>--latest</code>オプションを指定すると、<code>deno.json</code>で指定されたバージョンレンジに関わらず、常に最新バージョンへアップデートしてくれるようです:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ deno outdated --update --latest <span style=color:#e6db74>&#34;@nestjs/*&#34;</span>
</span></span></code></pre></div><p>また、ワークスペースの各メンバーの依存もアップデートしたい場合、<code>--recursive</code>オプションを指定します:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ deno outdated --recursive --update
</span></span></code></pre></div><h2 id=deno-task><code>deno task</code><a hidden class=anchor aria-hidden=true href=#deno-task>#</a></h2><h3 id=タスク間の依存関係の定義がサポート>タスク間の依存関係の定義がサポート<a hidden class=anchor aria-hidden=true href=#タスク間の依存関係の定義がサポート>#</a></h3><p>各タスク間の依存関係の定義がサポートされています。</p><p>この機能の導入に伴い、オブジェクト形式でのタスクの定義がサポートされています。現状では<code>command</code>, <code>description</code>, <code>dependencies</code>の3つのプロパティーを指定できます。</p><p>タスク間の依存関係を定義したい場合、<code>dependencies</code>プロパティーを指定する必要があります:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;tasks&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;check:all&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;command&#34;</span>: <span style=color:#e6db74>&#34;echo &#39;All checks have been passed!&#39;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Run all checks&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;dependencies&#34;</span>: [<span style=color:#e6db74>&#34;check:fmt&#34;</span>, <span style=color:#e6db74>&#34;check:deno-json&#34;</span>]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;check:fmt&#34;</span>: <span style=color:#e6db74>&#34;deno fmt --check&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;check:deno-json&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Check if deno.json is valid&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;command&#34;</span>: <span style=color:#e6db74>&#34;deno run --allow-read=deno.json tools/check_deno_json.js&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>上記の場合に<code>deno task check:all</code>を実行すると、まず<code>check:fmt</code>と<code>check:deno-json</code>タスクが並列で実行され、それらが成功した場合のみ<code>check:all</code>の<code>command</code>が実行されます。</p><p>引数なしで<code>deno task</code>を実行すると、<code>description</code>プロパティーに記載された内容がコメントとして表示されます (これに伴い、引数なしの<code>deno task</code>コマンドが<code>deno.jsonc</code>において各タスクに記述されたコメントを認識してくれる機能が削除されています)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> $ deno task
</span></span><span style=display:flex><span>Available tasks:
</span></span><span style=display:flex><span>- check:all
</span></span><span style=display:flex><span>    // Run all checks
</span></span><span style=display:flex><span>    echo OK
</span></span><span style=display:flex><span>    depends on: check:fmt, check:deno-json
</span></span><span style=display:flex><span>- check:fmt
</span></span><span style=display:flex><span>    deno fmt --check
</span></span><span style=display:flex><span>- check:deno-json
</span></span><span style=display:flex><span>    // Check <span style=color:#66d9ef>if</span> deno.json is valid
</span></span><span style=display:flex><span>    deno run --allow-read<span style=color:#f92672>=</span>deno.json tools/check
</span></span><span style=display:flex><span>_deno_json.js
</span></span></code></pre></div><h3 id=deno-workspacesのサポート>Deno workspacesのサポート<a hidden class=anchor aria-hidden=true href=#deno-workspacesのサポート>#</a></h3><p><code>deno task</code>コマンドに<code>--filter</code>オプションが追加されています。このオプションが指定されると、<a href=https://uki00a.github.io/deno-weekly/articles/deno/v1.45.html>ワークスペース</a>内において、名前がこのオプションで指定されたパターンにマッチするパッケージで定義されたタスクを実行できるようです:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 名前が`platform-*`パターンにマッチするメンバーのhiタスクを実行</span>
</span></span><span style=display:flex><span>$ deno task --filter <span style=color:#e6db74>&#39;platform-*&#39;</span> hi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># すべてのメンバーのhiタスクを実行</span>
</span></span><span style=display:flex><span>$ deno task --filter <span style=color:#e6db74>&#39;*&#39;</span> hi
</span></span></code></pre></div><h3 id=--evalオプションが追加><code>--eval</code>オプションが追加<a hidden class=anchor aria-hidden=true href=#--evalオプションが追加>#</a></h3><p>指定された引数をDenoに組み込まれた<a href=https://github.com/denoland/deno_task_shell><code>deno_task_shell</code></a>を使って評価してくれます:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ deno task --eval <span style=color:#e6db74>&#39;cat deno.json | jq .imports&#39;</span>
</span></span><span style=display:flex><span>Task  cat deno.json | jq .imports
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;@nestjs/common&#34;</span>: <span style=color:#e6db74>&#34;npm:@nestjs/common@^10&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;@nestjs/core&#34;</span>: <span style=color:#e6db74>&#34;npm:@nestjs/core@^10&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;@oak/oak&#34;</span>: <span style=color:#e6db74>&#34;jsr:@oak/oak@^17&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;@hono/hono&#34;</span>: <span style=color:#e6db74>&#34;jsr:@hono/hono@^4&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=deno-init><code>deno init</code><a hidden class=anchor aria-hidden=true href=#deno-init>#</a></h2><h3 id=--npmオプションのサポート><code>--npm</code>オプションのサポート<a hidden class=anchor aria-hidden=true href=#--npmオプションのサポート>#</a></h3><p><code>deno init --npm &lt;package名></code>のように実行すると、npmレジストリから<code>npm:create-&lt;package名></code>がダウンロードされ、実行されます。</p><p>例えば、以下のコマンドを実行すると<code>create-hono</code>パッケージが実行されます:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ deno init --npm hono
</span></span><span style=display:flex><span>⚠️ Do you fully trust npm:create-hono package? Deno will invoke code from it with all permissions. Do you want to <span style=color:#66d9ef>continue</span>? <span style=color:#f92672>[</span>y/n<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>&gt; 
</span></span></code></pre></div><h2 id=deno-compile><code>deno compile</code><a hidden class=anchor aria-hidden=true href=#deno-compile>#</a></h2><h3 id=実行可能ファイルへのローカルのファイルディレクトリの埋め込みがサポート---include>実行可能ファイルへのローカルのファイル/ディレクトリの埋め込みがサポート (<code>--include</code>)<a hidden class=anchor aria-hidden=true href=#実行可能ファイルへのローカルのファイルディレクトリの埋め込みがサポート---include>#</a></h3><p>ローカルに存在する任意のファイルやディレクトリの実行可能ファイルへの埋め込みがサポートされています:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#75715e>// main.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>info</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Deno</span>.<span style=color:#a6e22e>readTextFile</span>(<span style=color:#66d9ef>import</span>.<span style=color:#a6e22e>meta</span>.<span style=color:#a6e22e>dirname</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/data/test.txt&#34;</span>));
</span></span></code></pre></div><p><code>deno compile</code>に<code>--include</code>オプションを指定することで、ファイルまたはディレクトリを埋め込むことができます:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cat data/test.txt
</span></span><span style=display:flex><span>foo
</span></span><span style=display:flex><span>bar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ deno compile --output sample --include ./data ./main.js
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ./sample
</span></span><span style=display:flex><span>foo
</span></span><span style=display:flex><span>bar
</span></span></code></pre></div><h3 id=v8コードキャッシュのサポート>V8コードキャッシュのサポート<a hidden class=anchor aria-hidden=true href=#v8コードキャッシュのサポート>#</a></h3><p><code>deno compile</code>で生成される実行可能ファイルにおいても<a href=https://uki00a.github.io/deno-weekly/articles/deno/v1.43.html>V8コードキャッシュ</a>がサポートされました (この機能はデフォルトで有効化されており、<code>--no-code-cache</code>で無効化できます)</p><p>生成された実行可能ファイルの初回実行時に<code>/tmp</code>にV8コードキャッシュが保存されます。2回目以降の実行時に<code>/tmp</code>に保存されたV8コードキャッシュが読み込まれます。</p><h4 id=v8コードキャッシュの保存先について>V8コードキャッシュの保存先について<a hidden class=anchor aria-hidden=true href=#v8コードキャッシュの保存先について>#</a></h4><p>以下のPRにおいて、V8コードキャッシュの保存先のパスを表示してくれる変更が導入されています:</p><ul><li><a href=https://github.com/denoland/deno/pull/26977>chore(compile): log code cache file path (#26977)</a></li></ul><p>今後、この変更が導入されれば、以下のようにしてV8コードキャッシュの保存先を確認できるようになりそうです:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ DENO_LOG<span style=color:#f92672>=</span>debug ./sample
</span></span></code></pre></div><h2 id=deno-fmt><code>deno fmt</code><a hidden class=anchor aria-hidden=true href=#deno-fmt>#</a></h2><h3 id=sqlのフォーマットがサポート>SQLのフォーマットがサポート<a hidden class=anchor aria-hidden=true href=#sqlのフォーマットがサポート>#</a></h3><p><a href=https://uki00a.github.io/deno-weekly/articles/deno/v1.46.html>Deno v1.46</a>で導入された<code>deno fmt</code>でのYAMLやCSSなどのサポートに続いて、Deno v2.1では<code>.sql</code>ファイルのフォーマットが実験的にサポートされています。</p><p><code>deno.json</code>で<code>"unstable": ["fmt-sql"]</code>を指定する または <code>deno fmt</code>に<code>--unstable-sql</code>を指定することで、<code>.sql</code>ファイルのフォーマットが有効化されます。</p><h3 id=gitignoreのサポート><code>.gitignore</code>のサポート<a hidden class=anchor aria-hidden=true href=#gitignoreのサポート>#</a></h3><p><code>deno fmt</code>コマンドが<code>.gitignore</code>の内容を参照して、フォーマット対象から除外すべきファイルを判断するよう改善されています。</p><h2 id=deno-lint><code>deno lint</code><a hidden class=anchor aria-hidden=true href=#deno-lint>#</a></h2><h3 id=gitignoreのサポート-1><code>.gitignore</code>のサポート<a hidden class=anchor aria-hidden=true href=#gitignoreのサポート-1>#</a></h3><p><code>deno fmt</code>コマンドと同様に、<code>deno lint</code>コマンドでも<code>.gitignore</code>の内容を元にチェック対象から除外すべきファイルを判断するよう改善されています。</p><h3 id=deno-lint---json---checked_filesフィールドの追加><code>deno lint --json</code> - <code>checked_files</code>フィールドの追加<a hidden class=anchor aria-hidden=true href=#deno-lint---json---checked_filesフィールドの追加>#</a></h3><p>エラーが発生したファイルの一覧が格納されるようです:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ deno lint --json | jq .checked_files 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;/home/uki00a/ghq/github.com/uki00a/deno-sandbox/main.js&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>]</span>
</span></span></code></pre></div><h2 id=deno-lsp><code>deno lsp</code><a hidden class=anchor aria-hidden=true href=#deno-lsp>#</a></h2><h3 id=auto-importsでの-deno-typesディレクティブのサポート>Auto importsでの<code>// @deno-types</code>ディレクティブのサポート<a hidden class=anchor aria-hidden=true href=#auto-importsでの-deno-typesディレクティブのサポート>#</a></h3><p>自前で型定義を提供しないnpmパッケージなどに対して、<code>// @deno-types</code>付きで<code>import</code>文を挿入できるようにする機能が実装されています。</p><h3 id=denojsonが存在する場合エディタ向けに定義されたフォーマットに関する設定が無視されるように><code>deno.json</code>が存在する場合、エディタ向けに定義されたフォーマットに関する設定が無視されるように<a hidden class=anchor aria-hidden=true href=#denojsonが存在する場合エディタ向けに定義されたフォーマットに関する設定が無視されるように>#</a></h3><p>インデントなどに関する設定が<code>.vscode/settings.json</code>などの設定ファイルで定義されていると、<code>deno.json</code>で定義されたインデントなどの設定が無視されてしまう問題が修正されています。</p><h2 id=deno-publish><code>deno publish</code><a hidden class=anchor aria-hidden=true href=#deno-publish>#</a></h2><h3 id=--set-versionオプションの追加><code>--set-version</code>オプションの追加<a hidden class=anchor aria-hidden=true href=#--set-versionオプションの追加>#</a></h3><p>このオプションが指定された場合、パッケージが<code>deno.json</code>で指定されたバージョンではなくこのオプションで指定されたバージョンとして公開されます。</p><h2 id=deno-info><code>deno info</code><a hidden class=anchor aria-hidden=true href=#deno-info>#</a></h2><h3 id=web-cache-apiのキャッシュ先の表示がサポート>Web Cache APIのキャッシュ先の表示がサポート<a hidden class=anchor aria-hidden=true href=#web-cache-apiのキャッシュ先の表示がサポート>#</a></h3><p><code>deno info</code>コマンドが<a href=https://developer.mozilla.org/en-US/docs/Web/API/Cache>Web Cache API</a>のキャッシュ先として利用されるディレクトリを表示してくれるよう改善されています。</p><h2 id=deno-test><code>deno test</code><a hidden class=anchor aria-hidden=true href=#deno-test>#</a></h2><h3 id=ドキュメント内のコードブロックの実行--doc時にコメントが保持されない問題の修正>ドキュメント内のコードブロックの実行(<code>--doc</code>)時にコメントが保持されない問題の修正<a hidden class=anchor aria-hidden=true href=#ドキュメント内のコードブロックの実行--doc時にコメントが保持されない問題の修正>#</a></h3><p><a href=https://uki00a.github.io/deno-weekly/articles/2024/09/22.html><code>deno test --doc</code></a>でMarkdownやJSDocコメント内のコードブロックを実行する際に、コメントが削除されてしまい、<code>// @ts-expect-error</code>などが動作しない問題が修正されています。</p><h2 id=cli>CLI<a hidden class=anchor aria-hidden=true href=#cli>#</a></h2><h3 id=deno_trace_permissions環境変数の導入><code>DENO_TRACE_PERMISSIONS</code>環境変数の導入<a hidden class=anchor aria-hidden=true href=#deno_trace_permissions環境変数の導入>#</a></h3><p><code>DENO_TRACE_PERMISSIONS</code>という環境変数が導入されています。この環境変数を設定すると、パーミッションプロンプトにおいてスタックトレースの表示が有効化され、あるパーミッションがどこで要求されたか判断しやすくなります:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ DENO_TRACE_PERMISSIONS<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> deno run main.js
</span></span><span style=display:flex><span>┏ ⚠️  Deno requests read access to <span style=color:#e6db74>&#34;/home/uki00a/ghq/github.com/uki00a/deno-sandbox/data/test.txt&#34;</span>.
</span></span><span style=display:flex><span>┠─ Requested by <span style=color:#e6db74>`</span>Deno.readFile<span style=color:#f92672>()</span><span style=color:#e6db74>`</span> API.
</span></span><span style=display:flex><span>┃  ├─ op_fs_read_file_text_async <span style=color:#f92672>(</span>ext:core/00_infra.js:260:33<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>┃  ├─ Object.readTextFile <span style=color:#f92672>(</span>ext:deno_fs/30_fs.js:779:24<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>┃  └─ file:///home/uki00a/ghq/github.com/uki00a/deno-sandbox/main.js:1:25
</span></span><span style=display:flex><span>┠─ Learn more at: https://docs.deno.com/go/--allow-read
</span></span><span style=display:flex><span>┠─ Run again with --allow-read to bypass this prompt.
</span></span><span style=display:flex><span>┗ Allow? <span style=color:#f92672>[</span>y/n/A<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>y <span style=color:#f92672>=</span> yes, allow; n <span style=color:#f92672>=</span> no, deny; A <span style=color:#f92672>=</span> allow all read permissions<span style=color:#f92672>)</span> &gt; 
</span></span></code></pre></div><p>スタックトレースの収集は高価な処理のため、この機能は本番環境などにおいては無効化することがDenoの公式ブログでは推奨されています。</p><h3 id=--env-fileで複数のenvファイルの読み込みがサポート><code>--env-file</code>で複数の<code>.env</code>ファイルの読み込みがサポート<a hidden class=anchor aria-hidden=true href=#--env-fileで複数のenvファイルの読み込みがサポート>#</a></h3><p><code>--env-file</code>オプションを複数回指定することで、複数の<code>.env</code>ファイルの読み込みがサポートされています。</p><h3 id=--allow-env---特定の名前で始まる環境変数の参照がサポート><code>--allow-env</code> - 特定の名前で始まる環境変数の参照がサポート<a hidden class=anchor aria-hidden=true href=#--allow-env---特定の名前で始まる環境変数の参照がサポート>#</a></h3><p><code>--allow-env</code>に末尾が<code>*</code>で終わるパターンを指定した際に、該当のパターンに前方一致する環境変数への参照をまとめて許可することができます:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 名前が`APP_`から始まる環境変数の参照を許可します</span>
</span></span><span style=display:flex><span>$ deno run --allow-env<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;APP_*&#39;</span> main.js
</span></span></code></pre></div><h2 id=denolock><code>deno.lock</code><a hidden class=anchor aria-hidden=true href=#denolock>#</a></h2><h3 id=compileroptionsで指定された依存関係のサポート><code>compilerOptions</code>で指定された依存関係のサポート<a hidden class=anchor aria-hidden=true href=#compileroptionsで指定された依存関係のサポート>#</a></h3><p><code>deno.lock</code>が<code>deno.json</code>の<code>compilerOptions.jsxImportSource</code>や<code>compilerOptions.jsxImportSourceTypes</code>などで指定されたパッケージも追跡してくれるよう改善されています。</p><h2 id=deno-api>Deno API<a hidden class=anchor aria-hidden=true href=#deno-api>#</a></h2><h3 id=denotelemetry-opentelemetryのサポート><code>Deno.telemetry</code> (OpenTelemetryのサポート)<a hidden class=anchor aria-hidden=true href=#denotelemetry-opentelemetryのサポート>#</a></h3><p><code>Deno.telemetry</code>という実験的APIが追加されています。<code>--unstable-otel</code>または<code>deno.json</code>で<code>"unstable": ["otel"]</code>を指定することで有効化できます。</p><p>この<code>Deno.telemetry</code>と<a href=https://github.com/open-telemetry/opentelemetry-js>opentelemetry-js</a>を連携させるための<a href=https://github.com/denoland/otel><code>@deno/otel</code></a>というJSRパッケージが公開されています。</p><h3 id=denojupyterimage><code>Deno.jupyter.image</code><a hidden class=anchor aria-hidden=true href=#denojupyterimage>#</a></h3><p><code>Deno.jupyter.image</code>というAPIが追加されています。<code>.jpg</code>または<code>.png</code>ファイルをパスもしくは<code>Uint8Array</code>で指定することで、<a href=https://uki00a.github.io/deno-weekly/articles/deno/v1.37.html>Jupyter Notebook</a>上に指定された画像を表示できるようです。</p><h3 id=denofileinfoctime><code>Deno.FileInfo.ctime</code><a hidden class=anchor aria-hidden=true href=#denofileinfoctime>#</a></h3><p><code>Deno.stat</code>などで返却される<code>Deno.FileInfo</code>に<code>ctime</code>が追加されています。</p><h3 id=denoserve><code>Deno.serve</code><a hidden class=anchor aria-hidden=true href=#denoserve>#</a></h3><p>ブラウザーから<code>Accept-Encoding: gzip, deflate, br, zstd</code>が指定された場合、Brotliが使用されるよう挙動が改善されています。</p><h2 id=nodejs互換性の改善>Node.js互換性の改善<a hidden class=anchor aria-hidden=true href=#nodejs互換性の改善>#</a></h2><h3 id=--unstable-detect-cjsの安定化><code>--unstable-detect-cjs</code>の安定化<a hidden class=anchor aria-hidden=true href=#--unstable-detect-cjsの安定化>#</a></h3><p><a href=https://uki00a.github.io/deno-weekly/articles/2024/10/20.html><code>--unstable-detect-cjs</code></a>が指定されたときのみ有効化されていた、<code>package.json</code>で<code>"type": "commonjs"</code>が定義されているパッケージで<code>.js</code>ファイルをCommon JSモジュールとして読み込めるようにする機能がデフォルトで有効化されました。</p><h3 id=--unstable-node-globalsオプションが追加><code>--unstable-node-globals</code>オプションが追加<a hidden class=anchor aria-hidden=true href=#--unstable-node-globalsオプションが追加>#</a></h3><p>このオプションを指定することで、Node.jsの各種グローバルAPIを有効化することができます。例えば、以下のようにNode.jsのグローバルAPIに依存したスクリプトがあったとします:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>info</span>(<span style=color:#a6e22e>setImmediate</span>);
</span></span></code></pre></div><p>この場合、<code>--unstable-node-globals</code>オプションを指定することで、DenoでもNode.jsのグローバルAPIが参照されたスクリプトを実行することができます:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># `--unstable-node-globals`なしだとエラーが発生します</span>
</span></span><span style=display:flex><span>$ deno run main.js
</span></span><span style=display:flex><span>error: Uncaught <span style=color:#f92672>(</span>in promise<span style=color:#f92672>)</span> ReferenceError: setImmediate is not defined
</span></span><span style=display:flex><span>console.info<span style=color:#f92672>(</span>setImmediate<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>             ^
</span></span><span style=display:flex><span>    at file:///home/uki00a/ghq/github.com/uki00a/deno-sandbox/main.js:1:14
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    info: setImmediate is not available in the global scope in Deno.
</span></span><span style=display:flex><span>    hint: Import it explicitly with import <span style=color:#f92672>{</span> setImmediate <span style=color:#f92672>}</span> from <span style=color:#e6db74>&#34;node:timers&#34;</span>;,
</span></span><span style=display:flex><span>          or run again with --unstable-node-globals flag to add this global.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># `--unstable-node-globals`を指定すると、実行に成功します</span>
</span></span><span style=display:flex><span>$ deno run --unstable-node-globals main.js
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Function: setImmediate<span style=color:#f92672>]</span>
</span></span></code></pre></div><h3 id=nodeperf_hooks><code>node:perf_hooks</code><a hidden class=anchor aria-hidden=true href=#nodeperf_hooks>#</a></h3><p><code>monitorEventLoopDelay()</code>が実装されました。</p><h3 id=nodetimerspromises><code>node:timers/promises</code><a hidden class=anchor aria-hidden=true href=#nodetimerspromises>#</a></h3><p><code>setInterval()</code>が再実装され、互換性が改善されています。</p><h3 id=nodenet><code>node:net</code><a hidden class=anchor aria-hidden=true href=#nodenet>#</a></h3><p><code>createConnection()</code>で<code>autoSelectFamily</code>オプションがサポートされています。</p><h3 id=nodemodule><code>node:module</code><a hidden class=anchor aria-hidden=true href=#nodemodule>#</a></h3><p><code>getBuiltinModule()</code>が実装されています。</p><h3 id=nodezlib><code>node:zlib</code><a hidden class=anchor aria-hidden=true href=#nodezlib>#</a></h3><p><code>crc32()</code>が実装されています。</p><h3 id=nodecrypto><code>node:crypto</code><a hidden class=anchor aria-hidden=true href=#nodecrypto>#</a></h3><p><code>generateKeyPair()</code>で<code>promisify()</code> (<code>node:util</code>)が動作するよう改善されています。</p><h3 id=filenameの取り扱いの変更><code>.//&lt;filename></code>の取り扱いの変更<a hidden class=anchor aria-hidden=true href=#filenameの取り扱いの変更>#</a></h3><p>Node.jsと同様に、<code>.//&lt;filename></code>という形式のパスを<code>./&lt;filename></code>として取り扱うよう挙動が修正されています。</p><h3 id=deno-install><code>deno install</code><a hidden class=anchor aria-hidden=true href=#deno-install>#</a></h3><p>pnpmに合わせて、ライフサイクルスクリプトが実行されたnpmパッケージに対して、再度<code>bin</code>エントリがセットアップされるよう挙動が修正されています。<a href=https://github.com/supabase/cli>Supabase CLI</a>などが動作しない問題への対策のようです。</p><hr><ul><li><a href=https://github.com/denoland/deno/issues/26677>Installing a npm package with a bin populated by a postinstall script doesn&rsquo;t work (#26677)</a></li></ul><h2 id=web-api>Web API<a hidden class=anchor aria-hidden=true href=#web-api>#</a></h2><h3 id=fetchのリクエストボディでのasynciterableuint8arrayのサポート><code>fetch()</code>のリクエストボディでの<code>AsyncIterable&lt;Uint8Array></code>のサポート<a hidden class=anchor aria-hidden=true href=#fetchのリクエストボディでのasynciterableuint8arrayのサポート>#</a></h3><p><code>fetch()</code>のリクエストボディに対する<code>AsyncIterable&lt;Uint8Array></code>のサポートが再導入されています (この機能は<a href=https://uki00a.github.io/deno-weekly/articles/deno/v1.46.html>Deno v1.46.0</a>で一度導入され、<a href=https://uki00a.github.io/deno-weekly/articles/2024/09/01.html>Deno v1.46.2</a>にてrevertされていました)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createReadStream</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;node:fs&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>stream</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createReadStream</span>(<span style=color:#e6db74>&#34;./data.txt&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#34;http://localhost:8000/upload&#34;</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;POST&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>stream</span>
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=パフォーマンス改善>パフォーマンス改善<a hidden class=anchor aria-hidden=true href=#パフォーマンス改善>#</a></h2><h3 id=windowsでの起動の高速化>Windowsでの起動の高速化<a hidden class=anchor aria-hidden=true href=#windowsでの起動の高速化>#</a></h3><p>いくつかのDLLファイルを遅延読み込みさせることで、Windowsにおける起動速度が改善されているようです。</p><hr><ul><li><a href=https://github.com/denoland/deno/pull/26917>perf(windows): delay load webgpu and some other dlls (#26917)</a></li></ul><h3 id=out-of-memoryエラーへの対策>Out of Memoryエラーへの対策<a hidden class=anchor aria-hidden=true href=#out-of-memoryエラーへの対策>#</a></h3><p>Out of Memoryエラーへの対策として、V8のデフォルトのヒープ長がシステムで利用可能なメモリに応じて調整されるよう改善されています。</p><h2 id=v8-130>V8 13.0<a hidden class=anchor aria-hidden=true href=#v8-130>#</a></h2><p>Denoに組み込まれたV8のバージョンが13.0へアップデートされています。</p><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li><a href=https://deno.com/blog/v2.1>Deno 2.1: Wasm Imports and other enhancements</a></li><li><a href=https://github.com/denoland/deno/releases/tag/v2.1.0>https://github.com/denoland/deno/releases/tag/v2.1.0</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://uki00a.github.io/deno-weekly/tags/deno.html>deno</a></li><li><a href=https://uki00a.github.io/deno-weekly/tags/opentelemetry.html>OpenTelemetry</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://uki00a.github.io/deno-weekly/>週刊Deno</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>