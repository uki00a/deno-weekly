---
title: Deno v1.43
tags:
  - Deno
  - jsr
  - React
categories:
  - release
date: 2024-05-03
description:
---

Deno v1.43がリリースされました。

この記事では主な変更点などについて解説します。

## サーバー

### `deno serve`コマンド

HTTPサーバーの起動を簡略化するために`deno serve`コマンドが追加されました。

使い方などについては[こちらのページ]({{< ref "articles/2024/04/28.md" >}})を参照いただければと思います。

### `Request.signal`のサポート

`Deno.serve`のハンドラーに渡される`Request`オブジェクトで`signal`プロパティがサポートされています。

これについても詳細は[こちらのページ]({{< ref "articles/2024/04/28.md" >}})を参照いただければと思います。

### `Deno.HttpServer.addr`

`Deno.HttpServer`に`addr`プロパティが追加されています。HTTPサーバーの起動ポートなどを確認できます。

```jsx
const server = Deno.serve((req) => new Response("OK"));
console.info(server.addr.port); // => 8000
```

## Web API - `URL.parse`と`Float16Array`がサポート

新規APIとして`URL.parse`と`Float16Array`が実装されています。

```javascript
URL.parse("invalid-url"); // => null

URL.parse("http://localhost:8000/") instanceof URL; // => true
```

## TypeScript

### `compilerOptions.jsxImportSourceTypes`

`compilerOptions.jsxImportSourceTypes`というDeno独自のオプションが導入されました。

```json
{
  "compilerOptions": {
    "jsx": "react-jsx",
    "jsxImportSource": "npm:react@18.3.1",
    "jsxImportSourceTypes": "npm:@types/react@18.3.1"
  }
}
```

JSX Transformを有効化した場合、TypeScriptは`<some-jsx-package>/jsx-runtime`を`import`するようなコードを生成します。

```typescript
// 例) Reactの場合、以下のようなコードが生成されます
import {jsx as _jsx} from 'react/jsx-runtime';

// ...
```

元々、この`<some-jsx-package>/jsx-runtime`の`import`に対して適用すべき型定義を判断する方法がDenoには存在せず、JSX Transformを有効化してReactなどを使う場合に、型エラーが発生する課題がありました。(TypeScriptによって自動生成されるコードなため、`@deno-types`プラグマを適用することもできない)

この課題を解消するために、`compilerOptions.jsxImportSourceTypes`が導入されたようです。このオプションを指定することで、上記のような`<some-jsx-package/jsx-runtime`の`import`に対して、Denoがどの型定義を適用すればよいか判断できるようになります。また、`@jsxImportSource`などと同様に、ソースコード内で`@jsxImportSourceTypes`プラグマを指定することも可能です。

```typescript
/** @jsxImportSourceTypes npm:@types/react@18.3.1 */
```

Preactの場合はパッケージ内に型定義が同梱されているのでこの問題が起きないようなのですが、Reactの場合は`@types/react`で別管理されている関係もあり、専用の解決策が必要と判断されて導入されたようです。

---

- https://github.com/denoland/deno/issues/18203

### `compilerOptions.jsxPrecompileSkipElements`

`compilerOptions.jsxPrecompileSkipElements`というDeno独自のオプションが導入されています。[precompiled JSX transform]({{< ref "articles/deno/v1.38.md" >}})による最適化の適用対象外とするHTML要素を一覧で指定できます。

```json
{
  "compilerOptions": {
    "jsx": "precompile",
    "jsxImportSource": "preact",
    "jsxPrecompileSkipElements": ["a"]
  }
}
```

### サイドエフェクトimportに関する変更

`deno check`などによる型チェックで`.css`などのモジュールに対するサイドエフェクト`import`が検出された際に、型エラーが発生しないように挙動が修正されました。

```typescript
import "./app.css";
```

## Import maps

### workspaceメンバーの自動登録がサポート

各ワークスペースのメンバーがImport mapsへ自動で登録される機能が導入されています。

例えば、`deno.json`で以下のようにワークスペースが定義されていたとします。Import maps(`imports`)は定義されていません。

```json
{
  "workspaces": ["foo"]
}
```

`foo/deno.json`の内容は以下のように定義されていたとします。

```json
{
  "name": "@testing/foo",
  "version": "0.0.1",
  "exports": {
    ".": "./mod.ts"
  }
}
```

`foo/mod.ts`は以下のように定義されています。

```typescript
export function foo() {
  return 123;
}
```

この場合、`foo`ワークスペース(`@testing/foo`)は自動でImport mapsに登録され、以下のようにbare specifierを指定して`import`できます。

```typescript
// main.ts
import { foo } from "@testing/foo";
console.info(foo()); // => 123
```

### `importMap`で祖先のディレクトリの指定がサポート

`deno.json`の`importMap`オプションで祖先のディレクトリにあるImport mapsファイルが指定できるように改善されています。

```json
{
  "importMap": "../import_map.json"
}
```

## Deno v2に向けた変更

[`DENO_FUTURE=1`]({{< ref "articles/2024/02/18.md" >}})が設定されている際に、以下の変更が適用されるようになりました。

### `Deno.connectTls`の非推奨化されているオプションの無効化

下記オプションが無効化されます。

|対象オプション|移行先|
|:---:|:---:|
|`certFile`|[`cert`](https://deno.land/api@v1.43.1?s=Deno.TlsCertifiedKeyPem)オプション|
|`certChain`|[`cert`](https://deno.land/api@v1.43.1?s=Deno.TlsCertifiedKeyPem)オプション|
|`privateKey`|[`key`](https://deno.land/api@v1.43.1?s=Deno.TlsCertifiedKeyPem)オプション|

### `Deno.listenTls`の非推奨化されているオプションの無効化

下記オプションが無効化されます。

|対象オプション|移行先|
|:---:|:---:|
|`keyFile`|[`key`](https://deno.land/api@v1.43.1?s=Deno.TlsCertifiedKeyPem)オプション|
|`certFile`|[`cert`](https://deno.land/api@v1.43.1?s=Deno.TlsCertifiedKeyPem)オプション|

### `Deno.customInspect`の削除

`Symbol.for("Deno.customInspect")`への移行が推奨されます。

### Import Assertionsの無効化

[Import Attributes]({{< ref "articles/deno/v1.37.md" >}})への移行が推奨されます。

---

- [Deno 1.x to 2.x Migration Guide](https://github.com/denoland/deno-docs/blob/4cb3ca6e1d0354fa6dd28f840ac3e09046c1bcfe/runtime/manual/advanced/migrate_deprecations.md)
